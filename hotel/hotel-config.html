<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurações do Hotel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui}
body{background:#020617;color:#fff}
.container{max-width:900px;margin:auto;padding:24px}
.card{background:#0f172a;padding:22px;border-radius:18px;margin-bottom:22px}
label{display:block;margin:12px 0 6px}
input,textarea{width:100%;padding:12px;border-radius:12px;border:none;background:#020617;color:#fff}
button{margin-top:14px;background:#16a34a;color:#fff;border:none;padding:12px 18px;border-radius:14px;font-weight:700}
img{width:100%;height:220px;object-fit:cover;border-radius:14px;margin-top:14px;display:none}
</style>
</head>

<body>

<div class="container">
  <h2>⚙️ Configurações do Hotel</h2>

  <div class="card">
    <label>Nome do hotel</label>
    <input id="nome">

    <label>Descrição</label>
    <textarea id="descricao"></textarea>

    <label>WhatsApp</label>
    <input id="whatsapp">

    <button onclick="salvar()">Salvar dados</button>
  </div>

  <div class="card">
    <label>Banner do site</label>
    <input type="file" id="banner">
    <button onclick="uploadBanner()">Enviar banner</button>
    <img id="preview">
  </div>
</div>

<script>
const params = new URLSearchParams(location.search)
const id = params.get("id")

if(!id){
  document.body.innerHTML = "<h2 style='padding:30px'>Negócio não informado</h2>"
  throw new Error("sem id")
}

const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
)

const preview = document.getElementById("preview")

function bannerUrl(path){
  return `https://pdajixsoowcyhnjwhgpc.supabase.co/storage/v1/object/public/banners/${path}`
}

async function carregar(){
  const { data, error } = await sb
    .from("negocios")
    .select("nome, descricao, whatsapp, banner")
    .eq("id", id)
    .single()

  if(error){
    console.error(error)
    return
  }

  nome.value = data.nome || ""
  descricao.value = data.descricao || ""
  whatsapp.value = data.whatsapp || ""

  if(data.banner){
    preview.src = bannerUrl(data.banner)
    preview.style.display = "block"
  }
}

async function salvar(){
  const { error } = await sb
    .from("negocios")
    .update({
      nome: nome.value,
      descricao: descricao.value,
      whatsapp: whatsapp.value
    })
    .eq("id", id)

  if(error){
    alert("Erro ao salvar")
    console.error(error)
    return
  }

  alert("Dados salvos com sucesso")
}

async function uploadBanner(){
  const file = banner.files[0]
  if(!file) return alert("Escolha um arquivo")

  const path = `${id}/banner.jpg`

  const { error: uploadError } = await sb.storage
    .from("banners")
    .upload(path, file, { upsert:true })

  if(uploadError){
    alert("Erro no upload")
    console.error(uploadError)
    return
  }

  const { error: updateError } = await sb
    .from("negocios")
    .update({ banner: path })
    .eq("id", id)

  if(updateError){
    alert("Erro ao salvar banner")
    console.error(updateError)
    return
  }

  preview.src = bannerUrl(path) + "?v=" + Date.now()
  preview.style.display = "block"
  alert("Banner atualizado")
}

carregar()
</script>

</body>
</html>
