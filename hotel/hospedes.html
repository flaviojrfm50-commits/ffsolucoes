<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üë§ H√≥spedes - Hotel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- INIT SUPABASE (√öNICO) -->
<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin){
  alert("Sess√£o inv√°lida");
  window.location.href="login.html";
}

const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);
</script>

<link rel="icon" href="data:,">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #020617;
  color: #fff;
}
.topo {
  background: #0f172a;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.topo h2 { margin: 0; }
.voltar {
  background: #1e293b;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  cursor: pointer;
}
.container {
  padding: 32px;
  max-width: 1000px;
  margin: auto;
}
form {
  background: #0f172a;
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 30px;
}
input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-bottom: 12px;
  background: #1e293b;
  color: #fff;
}
button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #16a34a;
  color: #fff;
  font-weight: bold;
}
.tabela {
  width: 100%;
  border-collapse: collapse;
}
.tabela th, .tabela td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #1e293b;
}
.busca {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}
.busca input {
  flex: 1;
}
.btn-red {
  background: #dc2626;
}
</style>
</head>

<body>

<div class="topo">
  <h2>üë§ H√≥spedes - Hotel</h2>
  <button class="voltar" onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

  <h3>Cadastrar H√≥spede</h3>

  <form id="formHospede">
    <input type="text" id="nome" placeholder="Nome completo" required>
    <input type="text" id="documento" placeholder="Documento (CPF ou RG)">
    <input type="text" id="telefone" placeholder="Telefone (WhatsApp)">
    <input type="email" id="email" placeholder="E-mail">
    <button type="submit">Salvar H√≥spede</button>
  </form>

  <h3>Lista de H√≥spedes</h3>

  <div class="busca">
    <input type="text" id="busca" placeholder="Buscar h√≥spede pelo nome...">
    <button onclick="carregarHospedes()">üîç Buscar</button>
  </div>

  <table class="tabela">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Documento</th>
        <th>Telefone</th>
        <th>E-mail</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaHospedes"></tbody>
  </table>

</div>

<script>
/* ================= SESS√ÉO ================= */
function getSessao() {
  const admin = JSON.parse(localStorage.getItem("admin_logado"));
  if (!admin || !admin.app_id) {
    alert("Sess√£o inv√°lida. Fa√ßa login novamente.");
    location.replace("login.html");
    throw new Error("Sess√£o inv√°lida");
  }
  return admin.app_id;
}

const negocio_id = getSessao();
const db = window.db;

/* ================= CADASTRAR ================= */
const form = document.getElementById("formHospede");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const nome = document.getElementById("nome").value.trim();
  const documento = document.getElementById("documento").value.trim();
  const telefone = document.getElementById("telefone").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!nome) {
    alert("Informe o nome do h√≥spede.");
    return;
  }

  const { error } = await db.from("hotel_hospedes").insert([{
    negocio_id,
    nome,
    documento,
    telefone,
    email
  }]);

  if (error) {
    alert("Erro ao salvar: " + error.message);
    console.error(error);
    return;
  }

  form.reset();
  carregarHospedes();
});

/* ================= LISTAR ================= */
async function carregarHospedes() {
  const tabela = document.getElementById("tabelaHospedes");
  const termo = document.getElementById("busca").value.trim();

  tabela.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

  let query = db
    .from("hotel_hospedes")
    .select("*")
    .eq("negocio_id", negocio_id);

  if (termo) {
    query = query.ilike("nome", `%${termo}%`);
  }

  const { data, error } = await query.order("nome", { ascending: true });

  if (error) {
    tabela.innerHTML = "<tr><td colspan='5'>Erro ao carregar</td></tr>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    tabela.innerHTML = "<tr><td colspan='5'>Nenhum h√≥spede encontrado</td></tr>";
    return;
  }

  tabela.innerHTML = "";
  data.forEach(h => {
    tabela.innerHTML += `
      <tr>
        <td>${h.nome}</td>
        <td>${h.documento || "-"}</td>
        <td>${h.telefone || "-"}</td>
        <td>${h.email || "-"}</td>
        <td>
          <button class="btn-red" onclick="excluirHospede('${h.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

/* ================= EXCLUIR ================= */
async function excluirHospede(id) {
  if (!confirm("Deseja excluir este h√≥spede?")) return;

  const { error } = await db
    .from("hotel_hospedes")
    .delete()
    .eq("id", id)
    .eq("negocio_id", negocio_id);

  if (error) {
    alert("Erro ao excluir: " + error.message);
    console.error(error);
    return;
  }

  carregarHospedes();
}

/* ================= START ================= */
carregarHospedes();
</script>

</body>
</html>
