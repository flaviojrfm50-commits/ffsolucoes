<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ“… Reservas - Hotel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE CDN -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="icon" href="data:,">

<style>
/* (estilo mantido â€“ nÃ£o mexi) */
body { margin:0; font-family:Arial,sans-serif; background:#020617; color:#fff; }
.topo { background:#0f172a; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; }
.voltar { background:#1e293b; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
.container { padding:32px; max-width:1000px; margin:auto; }
form { background:#0f172a; padding:20px; border-radius:14px; margin-bottom:30px; }
input,select { width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:12px; background:#1e293b; color:#fff; }
button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:#16a34a; color:#fff; font-weight:bold; }
.tabela { width:100%; border-collapse:collapse; }
.tabela th,.tabela td { padding:12px; border-bottom:1px solid #1e293b; }
.status { padding:6px 10px; border-radius:6px; font-size:13px; font-weight:bold; }
.reservado { background:#2563eb; }
.hospedado { background:#b91c1c; }
.finalizado { background:#15803d; }
</style>
</head>

<body>

<div class="topo">
  <h2>ðŸ“… Reservas - Hotel</h2>
  <button class="voltar" onclick="history.back()">â¬… Voltar</button>
</div>

<div class="container">

<h3>Nova Reserva</h3>

<form id="formReserva">
  <select id="hospede" required></select>
  <select id="quarto" required></select>

  <label>Data de Check-in</label>
  <input type="date" id="checkin" required>

  <label>Data de Check-out</label>
  <input type="date" id="checkout" required>

  <input type="number" id="valor" placeholder="Valor total (auto)" readonly>

  <button type="submit">Salvar Reserva</button>
</form>

<h3>Reservas</h3>
<table class="tabela">
  <thead>
    <tr>
      <th>HÃ³spede</th>
      <th>Quarto</th>
      <th>Check-in</th>
      <th>Check-out</th>
      <th>Valor</th>
      <th>Status</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody id="tabelaReservas"></tbody>
</table>

</div>

<script>
/* ================= SESSÃƒO CENTRAL ================= */
function getSessao() {
  const admin = JSON.parse(localStorage.getItem("admin_logado"));
  if (!admin || !admin.app_id) {
    alert("SessÃ£o invÃ¡lida");
    location.replace("login.html");
    throw new Error("SessÃ£o invÃ¡lida");
  }
  return { admin, negocio_id: admin.app_id };
}

const { negocio_id } = getSessao();

/* ================= SUPABASE ================= */
const db = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= ELEMENTOS ================= */
const hospedeSelect = document.getElementById("hospede");
const quartoSelect  = document.getElementById("quarto");
const form          = document.getElementById("formReserva");
const valorInput    = document.getElementById("valor");
const checkinInput  = document.getElementById("checkin");
const checkoutInput = document.getElementById("checkout");
const tabela        = document.getElementById("tabelaReservas");

/* ================= CORREÃ‡ÃƒO MULTI-NEGÃ“CIO (USO MANUAL SE PRECISAR) ================= */
async function corrigirRegistro(tabela, id) {
  await db.from(tabela).update({ negocio_id }).eq("id", id);
}

/* ================= HÃ“SPEDES ================= */
async function carregarHospedes() {
  const { data, error } = await db
    .from("hotel_hospedes")
    .select("id, nome")
    .eq("negocio_id", negocio_id);

  if (error) return console.error(error);

  hospedeSelect.innerHTML = "<option value=''>Selecione o hÃ³spede</option>";
  data.forEach(h => {
    hospedeSelect.innerHTML += `<option value="${h.id}">${h.nome}</option>`;
  });
}

/* ================= QUARTOS ================= */
async function carregarQuartos() {
  const { data, error } = await db
    .from("hotel_quartos")
    .select("id, numero, preco_diaria")
    .eq("negocio_id", negocio_id)
    .neq("status", "ocupado");

  if (error) return console.error(error);

  quartoSelect.innerHTML = "<option value=''>Selecione o quarto</option>";
  data.forEach(q => {
    quartoSelect.innerHTML += `
      <option value="${q.id}" data-preco="${q.preco_diaria}">
        Quarto ${q.numero} - R$ ${q.preco_diaria}
      </option>`;
  });
}

/* ================= VALOR ================= */
function calcularValor() {
  const opt = quartoSelect.selectedOptions[0];
  if (!opt || !checkinInput.value || !checkoutInput.value) return;

  const preco = Number(opt.dataset.preco);
  const dias = (new Date(checkoutInput.value) - new Date(checkinInput.value)) / 86400000;
  valorInput.value = dias > 0 ? (dias * preco).toFixed(2) : 0;
}

checkinInput.onchange = calcularValor;
checkoutInput.onchange = calcularValor;
quartoSelect.onchange = calcularValor;

/* ================= SALVAR ================= */
form.addEventListener("submit", async e => {
  e.preventDefault();

  const reserva = {
    negocio_id,
    hospede_id: hospedeSelect.value,
    quarto_id: quartoSelect.value,
    data_checkin: checkinInput.value,
    data_checkout: checkoutInput.value,
    valor_total: Number(valorInput.value),
    status: "reservado"
  };

  const { error } = await db.from("hotel_reservas").insert(reserva);
  if (error) return alert(error.message);

  await db.from("hotel_quartos")
    .update({ status: "ocupado" })
    .eq("id", reserva.quarto_id);

  form.reset();
  valorInput.value = "";
  carregarTudo();
});

/* ================= LISTAR ================= */
async function carregarReservas() {
  tabela.innerHTML = "<tr><td colspan='7'>Carregando...</td></tr>";

  const { data, error } = await db
    .from("hotel_reservas")
    .select("*, hotel_hospedes(nome), hotel_quartos(numero)")
    .eq("negocio_id", negocio_id)
    .order("data_checkin", { ascending: false });

  if (error) return console.error(error);

  tabela.innerHTML = "";

  if (!data.length) {
    tabela.innerHTML = "<tr><td colspan='7'>Nenhuma reserva</td></tr>";
    return;
  }

  data.forEach(r => {
    tabela.innerHTML += `
      <tr>
        <td>${r.hotel_hospedes?.nome || "-"}</td>
        <td>${r.hotel_quartos?.numero || "-"}</td>
        <td>${r.data_checkin}</td>
        <td>${r.data_checkout}</td>
        <td>R$ ${r.valor_total.toFixed(2)}</td>
        <td><span class="status ${r.status}">${r.status}</span></td>
        <td>
          ${r.status === "reservado"
            ? `<button onclick="mudarStatus('${r.id}','hospedado')">Check-in</button>`
            : r.status === "hospedado"
            ? `<button onclick="mudarStatus('${r.id}','finalizado')">Check-out</button>`
            : ""}
        </td>
      </tr>`;
  });
}

/* ================= STATUS ================= */
window.mudarStatus = async (id, status) => {
  const { data } = await db
    .from("hotel_reservas")
    .update({ status })
    .eq("id", id)
    .select();

  if (status === "finalizado") {
    await db.from("hotel_quartos")
      .update({ status: "limpeza" })
      .eq("id", data[0].quarto_id);
  }

  carregarTudo();
};

/* ================= START ================= */
function carregarTudo() {
  carregarHospedes();
  carregarQuartos();
  carregarReservas();
}

carregarTudo();
</script>

</body>
</html>
