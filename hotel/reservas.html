<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üìÖ Reservas - Hotel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE CDN (UMD) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Remove erro de favicon -->
<link rel="icon" href="data:,">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #020617;
  color: #fff;
}
.topo {
  background: #0f172a;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.voltar {
  background: #1e293b;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  cursor: pointer;
}
.container {
  padding: 32px;
  max-width: 1000px;
  margin: auto;
}
form {
  background: #0f172a;
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 30px;
}
input, select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  margin-bottom: 12px;
  background: #1e293b;
  color: #fff;
}
button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #16a34a;
  color: #fff;
  font-weight: bold;
}
.tabela {
  width: 100%;
  border-collapse: collapse;
}
.tabela th, .tabela td {
  padding: 12px;
  border-bottom: 1px solid #1e293b;
}
.status {
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: bold;
}
.reservado { background: #2563eb; }
.hospedado { background: #b91c1c; }
.finalizado { background: #15803d; }
</style>
</head>

<body>

<div class="topo">
  <h2>üìÖ Reservas - Hotel</h2>
  <button class="voltar" onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">
  <h3>Nova Reserva</h3>

  <form id="formReserva">
    <select id="hospede" required></select>
    <select id="quarto" required></select>

    <label>Data de Check-in</label>
    <input type="date" id="checkin" required>

    <label>Data de Check-out</label>
    <input type="date" id="checkout" required>

    <input type="number" id="valor" placeholder="Valor total (auto)" readonly>

    <button type="submit">Salvar Reserva</button>
  </form>

  <h3>Reservas</h3>
  <table class="tabela">
    <thead>
      <tr>
        <th>H√≥spede</th>
        <th>Quarto</th>
        <th>Check-in</th>
        <th>Check-out</th>
        <th>Valor</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaReservas"></tbody>
  </table>
</div>

<script>
/* ================= AUTH ================= */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if (!admin) {
  alert("Sess√£o inv√°lida");
  location.href = "login.html";
}

const negocio_id = admin.app_id;

/* ================= SUPABASE ================= */
/* ‚ö†Ô∏è N√ÉO declare const supabase */
const db = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= ELEMENTOS ================= */
const hospedeSelect = document.getElementById("hospede");
const quartoSelect  = document.getElementById("quarto");
const form          = document.getElementById("formReserva");
const valorInput    = document.getElementById("valor");
const checkinInput  = document.getElementById("checkin");
const checkoutInput = document.getElementById("checkout");
const tabela        = document.getElementById("tabelaReservas");

/* ================= H√ìSPEDES ================= */
async function carregarHospedes() {
  const { data } = await db
    .from("hotel_hospedes")
    .select("*")
    .eq("negocio_id", negocio_id)
    .order("nome");

  hospedeSelect.innerHTML = "<option value=''>Selecione o h√≥spede</option>";
  data?.forEach(h => {
    hospedeSelect.innerHTML += `<option value="${h.id}">${h.nome}</option>`;
  });
}

/* ================= QUARTOS ================= */
async function carregarQuartos() {
  const { data } = await db
    .from("hotel_quartos")
    .select("*")
    .eq("negocio_id", negocio_id)
    .neq("status", "ocupado")
    .order("numero");

  quartoSelect.innerHTML = "<option value=''>Selecione o quarto</option>";
  data?.forEach(q => {
    quartoSelect.innerHTML += `
      <option value="${q.id}" data-preco="${q.preco_diaria}">
        Quarto ${q.numero} - R$ ${q.preco_diaria}
      </option>`;
  });
}

/* ================= VALOR ================= */
function calcularValor() {
  const opt = quartoSelect.selectedOptions[0];
  if (!opt || !checkinInput.value || !checkoutInput.value) return;

  const preco = Number(opt.dataset.preco);
  const dias = (new Date(checkoutInput.value) - new Date(checkinInput.value)) / 86400000;
  valorInput.value = dias > 0 ? (dias * preco).toFixed(2) : 0;
}

checkinInput.onchange = calcularValor;
checkoutInput.onchange = calcularValor;
quartoSelect.onchange = calcularValor;

/* ================= SALVAR ================= */
form.addEventListener("submit", async e => {
  e.preventDefault();

  const reserva = {
    negocio_id,
    hospede_id: hospedeSelect.value,
    quarto_id: quartoSelect.value,
    data_checkin: checkinInput.value,
    data_checkout: checkoutInput.value,
    valor_total: Number(valorInput.value),
    status: "reservado"
  };

  const { error } = await db.from("hotel_reservas").insert(reserva);
  if (error) return alert(error.message);

  await db.from("hotel_quartos")
    .update({ status: "ocupado" })
    .eq("id", reserva.quarto_id);

  form.reset();
  valorInput.value = "";
  carregarTudo();
});

/* ================= LISTAR ================= */
async function carregarReservas() {
  tabela.innerHTML = "<tr><td colspan='7'>Carregando...</td></tr>";

  const { data } = await db
    .from("hotel_reservas")
    .select("*, hotel_hospedes(nome), hotel_quartos(numero)")
    .eq("negocio_id", negocio_id)
    .order("data_checkin", { ascending: false });

  tabela.innerHTML = "";

  if (!data?.length) {
    tabela.innerHTML = "<tr><td colspan='7'>Nenhuma reserva</td></tr>";
    return;
  }

  data.forEach(r => {
    tabela.innerHTML += `
      <tr>
        <td>${r.hotel_hospedes?.nome || "-"}</td>
        <td>${r.hotel_quartos?.numero || "-"}</td>
        <td>${r.data_checkin}</td>
        <td>${r.data_checkout}</td>
        <td>R$ ${r.valor_total.toFixed(2)}</td>
        <td><span class="status ${r.status}">${r.status}</span></td>
        <td>
          ${r.status === "reservado"
            ? `<button onclick="mudarStatus('${r.id}','hospedado')">Check-in</button>`
            : r.status === "hospedado"
            ? `<button onclick="mudarStatus('${r.id}','finalizado')">Check-out</button>`
            : ""}
        </td>
      </tr>`;
  });
}

/* ================= STATUS ================= */
window.mudarStatus = async (id, status) => {
  const { data } = await db
    .from("hotel_reservas")
    .update({ status })
    .eq("id", id)
    .select();

  if (status === "finalizado") {
    await db.from("hotel_quartos")
      .update({ status: "limpeza" })
      .eq("id", data[0].quarto_id);
  }

  carregarTudo();
};

/* ================= START ================= */
function carregarTudo() {
  carregarHospedes();
  carregarQuartos();
  carregarReservas();
}

carregarTudo();
</script>

</body>
</html>
