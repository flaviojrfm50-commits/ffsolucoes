<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Super Admin | FF SoluÃ§Ãµes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:1200px;margin:40px auto;padding:30px;border-radius:20px;background:linear-gradient(135deg,#0f172a,#4b1fa0)}
h1,h2,h3{margin-top:25px}
input,select,button{width:100%;padding:14px;margin-top:10px;border-radius:12px;border:none}
button{background:#22c55e;color:#000;font-weight:bold;cursor:pointer}
button.danger{background:#e53935;color:#fff}
button.warn{background:#f59e0b;color:#000}
.card{background:#020617;padding:16px;margin-top:12px;border-radius:14px;display:flex;justify-content:space-between;gap:10px}
.login{max-width:420px;margin:80px auto}
hr{margin:40px 0;border:none;height:1px;background:rgba(255,255,255,.2)}
a{color:#22c55e;text-decoration:none}
.btn-small{width:auto;padding:6px 12px;font-size:12px;border-radius:8px}
.badge{background:#334155;padding:4px 8px;border-radius:6px;font-size:12px}
.badge.warn{background:#7c2d12}
</style>
</head>

<body>
<div class="container">

<h1>ğŸ‘‘ Super Admin â€” FF SoluÃ§Ãµes</h1>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <input id="usuarioSuper" placeholder="UsuÃ¡rio">
  <input id="senhaSuper" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">

<h2>ğŸ¢ NegÃ³cios (com vendedor)</h2>
<div id="listaNegocios"></div>

<hr>

<h2>ğŸ’° Vendedores</h2>
<div id="listaVendedores"></div>

</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* LOGIN */
window.login = async ()=>{
  const { data } = await supabase
    .from("super_admins")
    .select("*")
    .eq("usuario",usuarioSuper.value)
    .eq("senha",senhaSuper.value)
    .eq("ativo",true)
    .maybeSingle();

  if(!data) return alert("Login invÃ¡lido");

  loginBox.style.display="none";
  painel.style.display="block";
  carregarNegocios();
  carregarVendedores();
};

/* NEGÃ“CIOS + VENDEDOR */
async function carregarNegocios(){
  const { data } = await supabase
    .from("apps")
    .select(`
      id,
      nome,
      tipo,
      ativo,
      vendedor_id,
      usuarios (
        id,
        nome,
        ativo
      )
    `);

  listaNegocios.innerHTML="";

  (data||[]).forEach(n=>{
    const v = n.usuarios;

    const link =
      n.tipo==="hotel"
      ? `https://anajuliafarias659-cloud.github.io/ffsolucoes/hotel/public/site/index.html?id=${n.id}`
      : n.tipo==="locadora"
      ? `https://anajuliafarias659-cloud.github.io/ffsolucoes/locadora/public/index.html?app_id=${n.id}`
      : n.tipo==="mercado"
      ? `https://anajuliafarias659-cloud.github.io/ffsolucoes/mercado/public/catalogo.html?app=${n.id}`
      : `https://anajuliafarias659-cloud.github.io/ffsolucoes/bar/public/cardapio/index.html?app=${n.id}`;

    listaNegocios.innerHTML += `
      <div class="card">
        <div>
          <b>${n.nome}</b> <span class="badge">${n.tipo}</span><br>
          <small>Criado por:</small> ${v?.nome || "â€”"}<br>
          <small>Status negÃ³cio:</small> ${n.ativo ? "ğŸŸ¢ ativo" : "ğŸ”´ bloqueado"}<br>
          <small>Status vendedor:</small> ${v?.ativo ? "ğŸŸ¢ ativo" : "ğŸ”´ bloqueado"}<br>
          <a href="${link}" target="_blank">ğŸŒ Site pÃºblico</a>
        </div>

        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn-small"
            onclick="toggleNegocio('${n.id}', ${n.ativo})">
            ${n.ativo ? "ğŸ”’ Bloquear negÃ³cio" : "ğŸ”“ Desbloquear negÃ³cio"}
          </button>

          <button class="btn-small danger"
            onclick="excluirNegocio('${n.id}', ${n.ativo})">
            ğŸ—‘ï¸ Excluir negÃ³cio
          </button>
        </div>
      </div>
    `;
  });
}

/* BLOQUEAR / DESBLOQUEAR NEGÃ“CIO */
window.toggleNegocio = async (id,ativo)=>{
  await supabase.from("apps")
    .update({ ativo: !ativo })
    .eq("id", id);

  carregarNegocios();
};

/* EXCLUIR NEGÃ“CIO (6 MESES SEM PAGAR) */
window.excluirNegocio = async (id,ativo)=>{
  if(ativo){
    alert("Bloqueie o negÃ³cio antes de excluir.");
    return;
  }

  const { data } = await supabase
    .from("pagamentos")
    .select("created_at")
    .eq("app_id", id)
    .order("created_at",{ascending:false})
    .limit(1);

  const ultimo = data?.[0]?.created_at;
  const seisMeses = 1000*60*60*24*180;

  if(ultimo && (Date.now()-new Date(ultimo)) < seisMeses){
    alert("Pagamento recente. NÃ£o pode excluir.");
    return;
  }

  if(!confirm("Excluir negÃ³cio definitivamente?")) return;

  await supabase.from("apps").delete().eq("id",id);
  carregarNegocios();
};

/* VENDEDORES */
async function carregarVendedores(){
  const { data } = await supabase
    .from("usuarios")
    .select("*")
    .eq("tipo","vendedor");

  listaVendedores.innerHTML="";

  (data||[]).forEach(v=>{
    listaVendedores.innerHTML += `
      <div class="card">
        <div>
          <b>${v.nome}</b><br>
          <small>${v.email}</small><br>
          <span class="badge">ComissÃ£o ${v.comissao_percentual}%</span>
          ${!v.ativo ? `<span class="badge warn">Bloqueado</span>` : ""}
        </div>

        <button class="btn-small danger"
          onclick="excluirVendedor('${v.id}', ${v.ativo})">
          ğŸ—‘ï¸ Excluir vendedor
        </button>
      </div>
    `;
  });
}

/* EXCLUIR VENDEDOR (SEGURO) */
window.excluirVendedor = async (id,ativo)=>{
  if(ativo){
    alert("Bloqueie o vendedor antes de excluir.");
    return;
  }

  const { count } = await supabase
    .from("apps")
    .select("*",{count:"exact",head:true})
    .eq("vendedor_id", id)
    .eq("ativo", true);

  if(count>0){
    alert("Vendedor possui negÃ³cios ativos.");
    return;
  }

  if(!confirm("Excluir vendedor definitivamente?")) return;

  await supabase.from("usuarios").delete().eq("id",id);
  carregarVendedores();
};
</script>

</body>
</html>
