<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Vendedor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.login,.container{max-width:1100px;margin:40px auto;padding:30px;background:#0f172a;border-radius:20px}
input,select,button{width:100%;padding:14px;margin-top:10px;border-radius:12px;border:none}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.card{background:#020617;padding:16px;margin-top:12px;border-radius:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{background:#334155;padding:4px 8px;border-radius:6px;font-size:12px}
small{opacity:.8}
hr{margin:30px 0;border:none;height:1px;background:rgba(255,255,255,.2)}
a{color:#22c55e;text-decoration:none}
</style>
</head>

<body>

<!-- LOGIN DO VENDEDOR -->
<div class="login" id="loginBox">
  <h2>ğŸ” Login do Vendedor</h2>
  <input id="emailVendedor" placeholder="UsuÃ¡rio / E-mail">
  <input id="senhaVendedor" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div class="container" id="painel" style="display:none">

<h2>ğŸª Criar Novo NegÃ³cio</h2>

<div class="grid">
  <input id="nomeNegocio" placeholder="Nome do negÃ³cio">
  <select id="tipoNegocio">
    <option value="bar">Bar</option>
    <option value="restaurante">Restaurante</option>
    <option value="mercado">Mercado</option>
    <option value="locadora">Locadora</option>
  </select>

  <input id="enderecoNegocio" placeholder="EndereÃ§o">
  <input id="telefoneNegocio" placeholder="Telefone">

  <input id="nomeDono" placeholder="Nome do dono">
  <input id="loginDono" placeholder="UsuÃ¡rio do dono">
  <input id="senhaDono" type="password" placeholder="Senha do dono">
</div>

<button onclick="criarNegocio()">Cadastrar NegÃ³cio</button>

<hr>

<h2>ğŸ“Š Meus NegÃ³cios</h2>
<div id="listaNegocios"></div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

let vendedorLogado = null;

/* LOGIN DO VENDEDOR (COMPATÃVEL COM SISTEMA ANTIGO) */
window.login = async ()=>{
  const { data } = await supabase
    .from("usuarios")
    .select("*")
    .eq("usuario", emailVendedor.value)
    .eq("senha", senhaVendedor.value)
    .eq("tipo","vendedor")
    .eq("ativo",true)
    .maybeSingle();

  if(!data) return alert("Login invÃ¡lido");

  vendedorLogado = data;
  loginBox.style.display="none";
  painel.style.display="block";
  carregarNegocios();
};

/* CRIAR DONO + NEGÃ“CIO (RETROCOMPATÃVEL) */
window.criarNegocio = async ()=>{
  // cria usuÃ¡rio DONO (compatÃ­vel com login antigo)
  const { data: dono, error: erroDono } = await supabase
    .from("usuarios")
    .insert({
      nome: nomeDono.value,
      usuario: loginDono.value,   // ğŸ‘ˆ compatibilidade total
      email: loginDono.value,
      senha: senhaDono.value,
      tipo: "dono",
      ativo: true
    })
    .select()
    .single();

  if(erroDono){
    alert("Erro ao criar usuÃ¡rio do dono");
    return;
  }

  // cria negÃ³cio
  const { data: negocio, error } = await supabase
    .from("apps")
    .insert({
      nome: nomeNegocio.value,
      tipo: tipoNegocio.value,
      endereco: enderecoNegocio.value,
      telefone: telefoneNegocio.value,
      vendedor_id: vendedorLogado.id,
      dono_id: dono.id,
      dono_nome: nomeDono.value,
      dono_login: loginDono.value,
      ativo: true
    })
    .select()
    .single();

  if(error){
    alert("Erro ao criar negÃ³cio");
    return;
  }

  const linkPublico =
    tipoNegocio.value === "locadora"
    ? `https://anajuliafarias659-cloud.github.io/ffsolucoes/locadora/public/index.html?app_id=${negocio.id}`
    : `https://anajuliafarias659-cloud.github.io/ffsolucoes/bar/public/cardapio/index.html?app=${negocio.id}`;

  const linkPainel = "https://anajuliafarias659-cloud.github.io/ffsolucoes/";

  alert(
`âœ… NegÃ³cio criado com sucesso!

ğŸª ${negocio.nome}

ğŸ”— Painel do sistema:
${linkPainel}

ğŸ‘¤ UsuÃ¡rio:
${loginDono.value}

ğŸ”‘ Senha:
${senhaDono.value}

ğŸŒ Link pÃºblico:
${linkPublico}`
  );

  carregarNegocios();
};

/* LISTAR NEGÃ“CIOS DO VENDEDOR */
async function carregarNegocios(){
  const { data } = await supabase
    .from("apps")
    .select("*")
    .eq("vendedor_id", vendedorLogado.id);

  listaNegocios.innerHTML="";

  (data||[]).forEach(n=>{
    const linkPublico =
      n.tipo==="locadora"
      ? `https://anajuliafarias659-cloud.github.io/ffsolucoes/locadora/public/index.html?app_id=${n.id}`
      : `https://anajuliafarias659-cloud.github.io/ffsolucoes/bar/public/cardapio/index.html?app=${n.id}`;

    const msg = `
ğŸª Seu sistema estÃ¡ pronto!

ğŸ”— Painel:
https://anajuliafarias659-cloud.github.io/ffsolucoes/

ğŸ‘¤ UsuÃ¡rio: ${n.dono_login}
ğŸ”‘ Senha: conforme informado

ğŸŒ Link pÃºblico:
${linkPublico}
`;

    listaNegocios.innerHTML += `
      <div class="card">
        <b>${n.nome}</b> <span class="badge">${n.tipo}</span><br><br>

        <small>ğŸ“ EndereÃ§o:</small> ${n.endereco}<br>
        <small>ğŸ“ Telefone:</small> ${n.telefone}<br><br>

        <a href="${linkPublico}" target="_blank">ğŸŒ Abrir link pÃºblico</a><br><br>

        <button onclick="window.open('https://wa.me/55${n.telefone}?text=${encodeURIComponent(msg)}')">
          ğŸ“© Enviar informaÃ§Ãµes ao dono
        </button>
      </div>
    `;
  });
}
</script>

</body>
</html>
