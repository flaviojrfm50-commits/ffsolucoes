<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Catálogo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}

header{
  background:#0f172a;
  padding:20px;
  text-align:center;
}

header h1{margin:0}
header p{opacity:.8}

.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
}

.produto{
  background:#0f172a;
  padding:14px;
  border-radius:16px;
  text-align:center;
}

.produto img{
  width:100%;
  height:140px;
  object-fit:cover;
  border-radius:12px;
  margin-bottom:10px;
}

.produto h3{
  margin:6px 0;
  font-size:15px;
}

.preco{
  font-size:16px;
  font-weight:bold;
  margin:6px 0;
  color:#22c55e;
}

.vazio{
  text-align:center;
  opacity:.7;
  margin-top:40px;
}
</style>
</head>

<body>

<header>
  <h1 id="nomeMercado">Catálogo</h1>
  <p id="descricaoMercado"></p>
</header>

<div class="container">
  <div class="grid" id="lista"></div>
  <div class="vazio" id="vazio" style="display:none">
    Nenhum produto disponível
  </div>
</div>

<script>
/* ====== SUPABASE ====== */
const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ====== APP ====== */
const params = new URLSearchParams(window.location.search);
const app = params.get("app");

if(!app){
  document.body.innerText = "Mercado não encontrado";
  throw "";
}

/* ====== CONFIG DO SITE ====== */
(async ()=>{
  const { data: config } = await supabaseClient
    .from("config_site")
    .select("nome,descricao")
    .eq("app_id", app)
    .single();

  if(config){
    document.title = config.nome;
    nomeMercado.innerText = config.nome;
    descricaoMercado.innerText = config.descricao || "";
  }
})();

/* ====== PRODUTOS ====== */
async function carregarProdutos(){
  const { data, error } = await supabaseClient
    .from("produtos")
    .select("id,nome,preco,imagem")
    .eq("app_id", app)
    .eq("ativo", true)
    .order("nome");

  if(error){
    console.error(error);
    vazio.style.display="block";
    return;
  }

  if(!data || data.length===0){
    vazio.style.display="block";
    return;
  }

  lista.innerHTML = data.map(p=>`
    <div class="produto">
      ${p.imagem ? `<img src="${p.imagem}">` : ""}
      <h3>${p.nome}</h3>
      <div class="preco">R$ ${Number(p.preco).toFixed(2)}</div>
    </div>
  `).join("");
}

carregarProdutos();
</script>

</body>
</html>
