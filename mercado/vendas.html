<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.topo{padding:12px;border-bottom:1px solid #0f172a}
.brand{font-size:22px;font-weight:bold;color:#38bdf8}
.container{padding:12px;padding-bottom:220px}
.card{background:#0f172a;border-radius:14px;padding:12px;margin-bottom:10px}
input,button{width:100%;padding:10px;border-radius:10px;border:none}
input{background:#020617;color:#fff;margin-bottom:6px}
button{background:#0ea5e9;color:#fff;font-weight:bold;cursor:pointer;margin-bottom:6px}
.lista-item{padding:8px;border-radius:8px;background:#020617;margin-bottom:4px;cursor:pointer}
.lista-item:hover{background:#1e293b}
.dinheiro{background:#16a34a}
.pix{background:#0ea5e9}
.cartao{background:#2563eb}
.fiado{background:#7c3aed}
.info{text-align:center;font-weight:bold;margin-top:6px}
.total-fixo{
  position:fixed;bottom:0;left:0;width:100%;
  background:#020617;border-top:1px solid #0f172a;
  color:#38bdf8;text-align:center;padding:12px;font-size:18px
}
</style>
</head>

<body>

<div class="topo"><div class="brand">CAIXA</div></div>

<div class="container">

  <!-- BUSCA AUTOM√ÅTICA -->
  <div class="card">
    <input id="busca" placeholder="C√≥digo ou nome do produto" oninput="autoBuscar()">
    <div id="listaBusca"></div>
  </div>

  <!-- PREVIEW -->
  <div class="card" id="preview" style="display:none">
    <b id="pNome"></b>
    <p>R$ <span id="pPreco"></span> | Estoque: <span id="pEstoque"></span></p>
    <input id="qtd" type="number" min="1" value="1">
    <button onclick="adicionarCarrinho()">Adicionar</button>
  </div>

  <!-- CARRINHO -->
  <div class="card">
    <b>üõí Carrinho</b>
    <div id="carrinho"></div>
  </div>

  <!-- PAGAMENTO -->
  <div class="card">
    <b>üí≥ Pagamento</b>
    <input id="valorPago" type="number" step="0.01" placeholder="Valor pago" oninput="calcularInfo()">

    <button class="dinheiro" onclick="finalizarVenda('DINHEIRO')">Dinheiro</button>
    <button class="pix" onclick="finalizarVenda('PIX')">PIX</button>
    <button class="cartao" onclick="finalizarVenda('CARTAO')">Cart√£o</button>
    <button class="fiado" onclick="finalizarFiado()">Fiado</button>

    <div id="info" class="info"></div>
  </div>

</div>

<div class="total-fixo">
  TOTAL: R$ <span id="total">0.00</span>
</div>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));
const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

function round2(v){return Math.round(v*100)/100;}

let produtoAtual=null;
let carrinho=[];
let total=0;
let timerBusca=null;

/* ===== BUSCA AUTOM√ÅTICA ===== */
function autoBuscar(){
  clearTimeout(timerBusca);
  const v = busca.value.trim();

  if(v.length < 2){
    listaBusca.innerHTML="";
    return;
  }

  timerBusca = setTimeout(()=>{
    if(/^\d+$/.test(v) && v.length >= 8){
      buscarCodigo(v);
    }else{
      buscarNome(v);
    }
  },300);
}

async function buscarNome(v){
  const {data} = await supabaseClient
    .from("produtos")
    .select("*")
    .eq("app_id", admin.app_id)
    .ilike("nome", `%${v}%`)
    .limit(5);

  listaBusca.innerHTML="";
  data?.forEach(p=>{
    listaBusca.innerHTML+=`
      <div class="lista-item" onclick='selecionar(${JSON.stringify(p)})'>
        ${p.nome} ‚Äî R$ ${p.preco.toFixed(2)}
      </div>`;
  });
}

async function buscarCodigo(v){
  const {data} = await supabaseClient
    .from("produtos")
    .select("*")
    .eq("codigo_barra", v)
    .eq("app_id", admin.app_id)
    .maybeSingle();

  if(data) selecionar(data);
}

/* ===== PRODUTO ===== */
function selecionar(p){
  produtoAtual=p;
  pNome.innerText=p.nome;
  pPreco.innerText=p.preco.toFixed(2);
  pEstoque.innerText=p.estoque;
  preview.style.display="block";
  listaBusca.innerHTML="";
}

function adicionarCarrinho(){
  const q=Number(qtd.value);
  if(q>produtoAtual.estoque)return alert("Estoque insuficiente");

  carrinho.push({
    id:produtoAtual.id,
    nome:produtoAtual.nome,
    qtd:q,
    preco:produtoAtual.preco,
    subtotal:round2(q*produtoAtual.preco)
  });

  atualizarCarrinho();
  preview.style.display="none";
  busca.value="";
  qtd.value=1;
}

/* ===== CARRINHO ===== */
function atualizarCarrinho(){
  carrinho.innerHTML="";
  total=0;
  carrinhoDiv.innerHTML="";
  carrinho.forEach(i=>{
    total+=i.subtotal;
    carrinhoDiv.innerHTML+=`${i.qtd}x ${i.nome} = R$ ${i.subtotal.toFixed(2)}<br>`;
  });
  total=round2(total);
  totalSpan.innerText=total.toFixed(2);
}

/* ===== INFO ===== */
function calcularInfo(){
  info.innerText="";
  if(total<=0)return;

  const pago=round2(Number(valorPago.value));
  if(isNaN(pago)||pago<=0)return;

  const minimo=round2(total*0.9);
  if(pago<minimo){
    info.innerText=`‚ö†Ô∏è Falta R$ ${(total-pago).toFixed(2)}`;
    info.style.color="#f87171";
    return;
  }

  info.style.color="#22c55e";
  if(pago<total) info.innerText=`Desconto: R$ ${(total-pago).toFixed(2)}`;
  else if(pago>total) info.innerText=`Troco: R$ ${(pago-total).toFixed(2)}`;
  else info.innerText="Pagamento exato";
}

/* ===== FINALIZAR ===== */
async function finalizarVenda(tipo){
  if(carrinho.length===0)return alert("Carrinho vazio");

  const pago=round2(Number(valorPago.value));
  if(pago<=0)return alert("Informe valor");

  if(tipo!=="DINHEIRO" && pago>total)
    return alert("PIX/Cart√£o n√£o aceita valor maior");

  if(pago<round2(total*0.9))
    return alert("Desconto m√°ximo 10%");

  for(const i of carrinho){
    await supabaseClient.from("vendas").insert({
      app_id:admin.app_id,
      produto_id:i.id,
      quantidade:i.qtd,
      valor_total:total,
      valor_pago:pago,
      valor_devido:0,
      forma_pagamento:tipo
    });
  }

  limpar();
}

/* ===== FIADO ===== */
async function finalizarFiado(){
  if(carrinho.length===0)return alert("Carrinho vazio");

  const pago=round2(Number(valorPago.value)||0);
  const devido=round2(total-pago);
  if(devido<=0)return alert("Nada a fiar");

  let cpf=prompt("CPF:");
  if(!cpf)return;
  cpf=cpf.replace(/\D/g,"");
  if(cpf.length!==11)return alert("CPF inv√°lido");

  const {data}=await supabaseClient
    .from("vendas")
    .select("valor_devido,cliente_nome")
    .eq("cliente_cpf",cpf)
    .gt("valor_devido",0);

  let soma=0,nome="";
  data?.forEach(d=>{
    soma+=Number(d.valor_devido||0);
    if(d.cliente_nome)nome=d.cliente_nome;
  });

  if(soma+devido>10)return alert("Cliente acima do limite");

  if(!nome){
    nome=prompt("Nome:");
    if(!nome)return;
  }

  for(const i of carrinho){
    await supabaseClient.from("vendas").insert({
      app_id:admin.app_id,
      produto_id:i.id,
      quantidade:i.qtd,
      valor_total:total,
      valor_pago:pago,
      valor_devido:devido,
      forma_pagamento:"FIADO",
      cliente_nome:nome,
      cliente_cpf:cpf
    });
  }

  limpar();
}

/* ===== LIMPAR ===== */
function limpar(){
  carrinho=[];
  carrinhoDiv.innerHTML="";
  total=0;
  totalSpan.innerText="0.00";
  valorPago.value="";
  info.innerText="";
}
</script>

</body>
</html>
