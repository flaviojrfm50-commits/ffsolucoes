<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa | FF Solu√ß√µes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.card{background:#0f172a;border-radius:14px;padding:14px;margin:10px}
input,button{width:100%;padding:14px;font-size:18px;border:none;border-radius:10px}
input{background:#020617;color:#fff}
button{background:#0ea5e9;color:#fff;margin-top:6px}
#lista div{padding:10px;border-bottom:1px solid #1e293b;cursor:pointer}
#lista div:hover{background:#1e293b}
</style>
</head>

<body>

<div class="card">
  <input id="busca" placeholder="Digite nome ou c√≥digo" autocomplete="off">
  <div id="lista"></div>
  <button onclick="abrirLeitor()">üì∑ Ler c√≥digo</button>
  <div id="leitor" style="display:none"></div>
</div>

<div class="card" id="preview" style="display:none">
  <h3 id="nome"></h3>
  <p>Pre√ßo: R$ <span id="preco"></span></p>
  <p>Estoque: <span id="estoque"></span></p>
</div>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));

const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const busca = document.getElementById("busca");
const lista = document.getElementById("lista");

let produtoAtual = null;

/* üî§ BUSCA POR NOME ‚Äî AUTOM√ÅTICA */
busca.addEventListener("input", async () => {
  const valor = busca.value.trim();
  lista.innerHTML = "";
  preview.style.display = "none";

  // üëâ s√≥ busca se tiver LETRA
  if (!/[a-zA-Z]/.test(valor)) return;

  const { data, error } = await supabaseClient
    .from("produtos")
    .select("id,nome,preco,estoque")
    .ilike("nome", `%${valor}%`)
    .eq("app_id", admin.app_id)
    .limit(6);

  if (error || !data) return;

  data.forEach(p => {
    const d = document.createElement("div");
    d.textContent = `${p.nome} - R$ ${p.preco.toFixed(2)}`;
    d.onclick = () => mostrar(p);
    lista.appendChild(d);
  });
});

/* ‚èé ENTER = BUSCA POR C√ìDIGO */
busca.addEventListener("keydown", async (e) => {
  if (e.key !== "Enter") return;

  const codigo = busca.value.trim();
  if (!codigo) return;

  const { data } = await supabaseClient
    .from("produtos")
    .select("id,nome,preco,estoque")
    .eq("codigo_barra", codigo)
    .eq("app_id", admin.app_id)
    .single();

  if (!data) {
    alert("Produto n√£o encontrado");
    return;
  }

  mostrar(data);
});

/* MOSTRAR PRODUTO */
function mostrar(p){
  produtoAtual = p;
  nome.innerText = p.nome;
  preco.innerText = p.preco.toFixed(2);
  estoque.innerText = p.estoque;
  preview.style.display = "block";
  lista.innerHTML = "";
}

/* üì∑ LEITOR */
function abrirLeitor(){
  leitor.style.display="block";
  Quagga.init({
    inputStream:{type:"LiveStream",target:leitor},
    decoder:{readers:["ean_reader","code_128_reader"]}
  },()=>Quagga.start());

  Quagga.onDetected(r=>{
    busca.value = r.codeResult.code;
    Quagga.stop();
    leitor.style.display="none";
    // for√ßa busca por c√≥digo
    busca.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"}));
  });
}
</script>

</body>
</html>
