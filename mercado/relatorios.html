<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fiados | FF Solu√ß√µes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial;background:#020617;color:#e5e7eb}
.topo{padding:12px;border-bottom:1px solid #0f172a}
.topo b{font-size:20px;color:#38bdf8}
.container{padding:12px}
.card{background:#0f172a;border-radius:14px;padding:12px;margin-bottom:14px}
.linha{display:flex;justify-content:space-between;margin:4px 0}
.valor{color:#f87171;font-weight:bold}
.debito{padding:6px;border-bottom:1px solid #1e293b}
.obs{font-size:12px;color:#94a3b8;margin-left:22px}
input[type=checkbox]{transform:scale(1.2)}
input[type=text],input[type=date]{
  width:100%;padding:10px;margin:6px 0;
  border-radius:10px;border:none;
  background:#020617;color:#fff
}
button{
  width:100%;padding:10px;border:none;border-radius:10px;
  background:#22c55e;color:#020617;
  font-weight:bold;cursor:pointer;margin-top:6px
}
.btn-danger{
  background:#ef4444;color:#fff
}
.totalCliente{
  font-weight:bold;margin:6px 0;color:#f87171
}
.filtros{
  margin-bottom:12px
}
</style>
</head>

<body>

<div class="topo">
  <b>üìã FIADOS POR CLIENTE</b>
</div>

<div class="container">

  <!-- FILTROS -->
  <div class="filtros">
    <input id="pesquisa" type="text"
      placeholder="Pesquisar por nome ou CPF..."
      oninput="filtrarFiados()">

    <input id="filtroData" type="date"
      onchange="filtrarFiados()">

    <button class="btn-danger" onclick="limparRelatorio()">
      üßπ Limpar relat√≥rio de fiados
    </button>
  </div>

  <div id="listaFiados">Carregando...</div>
</div>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));

const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* üîê senha do bot√£o limpar */
const SENHA_LIMPAR = "1234";

let dadosFiados = [];

async function carregarFiados(){
  const { data, error } = await supabaseClient
    .from("vendas")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("forma_pagamento", "FIADO")
    .gt("valor_devido", 0)
    .neq("status", "ARQUIVADO")
    .order("created_at", { ascending: true });

  if(error){
    document.getElementById("listaFiados").innerHTML =
      "<p>Erro ao carregar fiados</p>";
    return;
  }

  dadosFiados = data || [];
  renderizarFiados(dadosFiados);
}

function filtrarFiados(){
  const termo = document.getElementById("pesquisa").value.toLowerCase().trim();
  const dataFiltro = document.getElementById("filtroData").value;

  let filtrado = [...dadosFiados];

  if(termo){
    filtrado = filtrado.filter(v =>
      (v.cliente_nome || "").toLowerCase().includes(termo) ||
      (v.cliente_cpf || "").includes(termo)
    );
  }

  if(dataFiltro){
    filtrado = filtrado.filter(v =>
      v.created_at.startsWith(dataFiltro)
    );
  }

  renderizarFiados(filtrado);
}

function renderizarFiados(data){
  const container = document.getElementById("listaFiados");
  container.innerHTML = "";

  if(!data || data.length === 0){
    container.innerHTML = "<p>Nenhum fiado encontrado</p>";
    return;
  }

  const clientes = {};
  data.forEach(v=>{
    if(!clientes[v.cliente_cpf]){
      clientes[v.cliente_cpf] = {
        nome: v.cliente_nome,
        cpf: v.cliente_cpf,
        total: 0,
        debitos: []
      };
    }
    clientes[v.cliente_cpf].total += Number(v.valor_devido);
    clientes[v.cliente_cpf].debitos.push(v);
  });

  Object.values(clientes).forEach(cliente=>{
    let html = `
      <div class="card">
        <div class="linha">
          <b>üë§ ${cliente.nome}</b>
          <span class="totalCliente">
            Total: R$ ${cliente.total.toFixed(2)}
          </span>
        </div>
    `;

    cliente.debitos.forEach(d=>{
      html += `
        <div class="debito">
          <label>
            <input type="checkbox" class="chk" data-id="${d.id}">
            ${new Date(d.created_at).toLocaleDateString("pt-BR")}
            ‚Äî R$ ${Number(d.valor_devido).toFixed(2)}
          </label>
          ${d.observacao ? `<div class="obs">üìù ${d.observacao}</div>` : ""}
        </div>
      `;
    });

    html += `
      <button onclick="quitarSelecionados('${cliente.cpf}')">
        Quitar selecionados
      </button>
      <button onclick="quitarTodos('${cliente.cpf}')">
        Quitar todas
      </button>
      </div>
    `;

    container.innerHTML += html;
  });
}

async function quitarSelecionados(){
  const checks = document.querySelectorAll(".chk:checked");
  if(checks.length === 0){
    alert("Nenhuma d√≠vida selecionada");
    return;
  }

  if(!confirm("Confirmar quita√ß√£o das d√≠vidas selecionadas?")) return;

  for(const c of checks){
    await supabaseClient
      .from("vendas")
      .update({
        valor_devido: 0,
        status: "PAGO",
        data_pagamento: new Date()
      })
      .eq("id", c.dataset.id);
  }

  carregarFiados();
}

async function quitarTodos(cpf){
  if(!confirm("Quitar TODAS as d√≠vidas desse cliente?")) return;

  await supabaseClient
    .from("vendas")
    .update({
      valor_devido: 0,
      status: "PAGO",
      data_pagamento: new Date()
    })
    .eq("cliente_cpf", cpf)
    .eq("forma_pagamento", "FIADO")
    .gt("valor_devido", 0);

  carregarFiados();
}

/* üßπ LIMPAR RELAT√ìRIO */
async function limparRelatorio(){
  const senha = prompt("Digite a senha para limpar o relat√≥rio:");
  if(senha !== SENHA_LIMPAR){
    alert("Senha incorreta");
    return;
  }

  if(!confirm("Isso vai ARQUIVAR todos os fiados quitados. Continuar?")) return;

  await supabaseClient
    .from("vendas")
    .update({ status: "ARQUIVADO" })
    .eq("app_id", admin.app_id)
    .eq("forma_pagamento", "FIADO")
    .eq("status", "PAGO");

  alert("Relat√≥rio de fiados limpo com sucesso");
  carregarFiados();
}

carregarFiados();
</script>

</body>
</html>
