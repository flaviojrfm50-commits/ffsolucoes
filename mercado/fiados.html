<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fiados | FF SoluÃ§Ãµes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial;background:#020617;color:#e5e7eb}
.topo{padding:12px;border-bottom:1px solid #0f172a}
.topo b{font-size:20px;color:#38bdf8}
.container{padding:12px}
.card{background:#0f172a;border-radius:14px;padding:12px;margin-bottom:14px}
.linha{display:flex;justify-content:space-between;margin:4px 0}
.valor{color:#f87171;font-weight:bold}
.debito{padding:6px;border-bottom:1px solid #1e293b}
small{color:#94a3b8}
button{
  width:100%;padding:10px;border:none;border-radius:10px;
  background:#22c55e;color:#020617;font-weight:bold;
  cursor:pointer;margin-top:8px
}
input[type=checkbox]{transform:scale(1.2)}
.totalCliente{
  font-weight:bold;
  margin:6px 0;
  color:#f87171
}
</style>
</head>

<body>

<div class="topo">
  <b>ðŸ“‹ FIADOS POR CLIENTE</b>
</div>

<div class="container" id="listaFiados">
  Carregando...
</div>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));

const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

async function carregarFiados(){
  const { data, error } = await supabaseClient
    .from("vendas")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("forma_pagamento", "FIADO")
    .gt("valor_devido", 0)
    .order("created_at", { ascending: true });

  const container = document.getElementById("listaFiados");
  container.innerHTML = "";

  if(error || !data || data.length === 0){
    container.innerHTML = "<p>Nenhum fiado em aberto</p>";
    return;
  }

  // AGRUPA POR CLIENTE
  const clientes = {};
  data.forEach(v=>{
    if(!clientes[v.cliente_cpf]){
      clientes[v.cliente_cpf] = {
        nome: v.cliente_nome,
        cpf: v.cliente_cpf,
        total: 0,
        debitos: []
      };
    }
    clientes[v.cliente_cpf].total += Number(v.valor_devido);
    clientes[v.cliente_cpf].debitos.push(v);
  });

  // RENDER
  Object.values(clientes).forEach(cliente=>{
    let html = `
      <div class="card">
        <div class="linha">
          <b>ðŸ‘¤ ${cliente.nome}</b>
          <span class="totalCliente">
            Total: R$ ${cliente.total.toFixed(2)}
          </span>
        </div>
    `;

    cliente.debitos.forEach(d=>{
      html += `
        <div class="debito">
          <label>
            <input type="checkbox" class="chk"
              data-id="${d.id}"
              data-valor="${d.valor_devido}">
            ${new Date(d.created_at).toLocaleDateString("pt-BR")}
            â€” R$ ${Number(d.valor_devido).toFixed(2)}
          </label>
        </div>
      `;
    });

    html += `
      <button onclick="quitarSelecionados('${cliente.cpf}')">
        Quitar Selecionados
      </button>
      <button onclick="quitarTodos('${cliente.cpf}')">
        Quitar TODOS
      </button>
      </div>
    `;

    container.innerHTML += html;
  });
}

/* QUITA APENAS MARCADOS */
async function quitarSelecionados(cpf){
  const checks = document.querySelectorAll(
    `.chk[data-id][data-valor]`
  );

  const selecionados = [...checks].filter(c=>c.checked);
  if(selecionados.length === 0){
    alert("Nenhuma dÃ­vida selecionada");
    return;
  }

  if(!confirm("Confirmar quitaÃ§Ã£o das dÃ­vidas selecionadas?")) return;

  for(const c of selecionados){
    await supabaseClient
      .from("vendas")
      .update({
        valor_devido: 0,
        status: "PAGO",
        data_pagamento: new Date()
      })
      .eq("id", c.dataset.id);
  }

  carregarFiados();
}

/* QUITA TODAS DO CLIENTE */
async function quitarTodos(cpf){
  if(!confirm("Quitar TODAS as dÃ­vidas desse cliente?")) return;

  await supabaseClient
    .from("vendas")
    .update({
      valor_devido: 0,
      status: "PAGO",
      data_pagamento: new Date()
    })
    .eq("cliente_cpf", cpf)
    .eq("forma_pagamento", "FIADO")
    .gt("valor_devido", 0);

  carregarFiados();
}

carregarFiados();
</script>

</body>
</html>
