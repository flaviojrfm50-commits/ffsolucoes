<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja de Roupas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#020617;color:#fff}

/* BANNER */
.banner{width:100%;height:260px;background:#0f172a;}
.banner img{width:100%;height:100%;object-fit:cover}

/* TOPO */
.topo{padding:24px;text-align:center}
.topo h1{margin:0}
.topo p{opacity:.7}

/* CONTAINER */
.container{max-width:1200px;margin:30px auto;padding:0 20px}

/* FILTROS */
.filtros{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px}
input,select{padding:12px;border-radius:10px;border:none;background:#0f172a;color:#fff}

/* GRID PRODUTOS */
.grid{
  display:grid;
  gap:18px;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
}

@media (min-width: 768px) {
  .grid{grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));}
}

@media (min-width: 1024px) {
  .grid{grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));}
}

/* CARD */
.card{background:#0f172a;border-radius:16px;padding:14px;text-align:center;cursor:pointer}
.card img{width:100%;height:180px;object-fit:cover;border-radius:12px}
.nome{margin:10px 0 5px;font-weight:bold}
.preco{color:#22c55e;font-size:18px;font-weight:bold}
small{opacity:.7}
.botao{margin-top:10px;padding:10px;border-radius:10px;border:none;background:#22c55e;color:#000;font-weight:bold;cursor:pointer;width:100%}

/* MODAL GALERIA */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#020617;padding:20px;border-radius:16px;max-width:90%;max-height:90%;overflow:auto}
.fechar{text-align:right;margin-bottom:10px}
.fechar button{background:#ef4444;border:none;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer}
.galeria{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
.galeria img{width:100%;height:150px;object-fit:cover;border-radius:12px}
</style>
</head>

<body>

<!-- BANNER -->
<div id="banner" class="banner"></div>

<!-- TOPO -->
<div class="topo">
  <h1 id="nomeLoja">üëï Loja de Roupas</h1>
  <p id="descLoja">Confira nossas pe√ßas dispon√≠veis</p>
</div>

<div class="container">

  <!-- FILTROS -->
  <div class="filtros">
    <input id="busca" placeholder="Buscar produto..." oninput="filtrar()">
    <select id="categoria" onchange="filtrar()">
      <option value="">Todas categorias</option>
      <option>Camisetas</option>
      <option>Cal√ßas</option>
      <option>Bermudas</option>
      <option>Vestidos</option>
      <option>Casacos</option>
      <option>Outros</option>
    </select>
  </div>

  <!-- PRODUTOS -->
  <div id="produtos" class="grid"></div>

</div>

<!-- MODAL GALERIA -->
<div id="modal" class="modal" onclick="fecharModal(event)">
  <div class="modal-content">
    <div class="fechar">
      <button onclick="fecharModal()">Fechar</button>
    </div>
    <div id="galeria" class="galeria"></div>
  </div>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* APP_ID */
const params = new URLSearchParams(window.location.search);
const APP_ID = params.get("app");

if(!APP_ID){
  document.body.innerHTML = `<div style="padding:40px;text-align:center"><h2>Acesso inv√°lido</h2><p>Link inv√°lido.</p></div>`;
  throw new Error("app_id ausente");
}

let lista = [];

/* CONFIG DO SITE */
async function carregarConfig(){
  const { data } = await sb
    .from("config_site")
    .select("nome_site, descricao_site, banner_url")
    .eq("app_id", APP_ID)
    .maybeSingle();

  if(!data) return;
  if(data.banner_url) document.getElementById("banner").innerHTML = `<img src="${data.banner_url}">`;
  if(data.nome_site) document.getElementById("nomeLoja").innerText = data.nome_site;
  if(data.descricao_site) document.getElementById("descLoja").innerText = data.descricao_site;
}

/* PRODUTOS */
async function carregarProdutos(){
  const { data } = await sb
    .from("produtos")
    .select("*")
    .eq("ativo", true)
    .eq("app_id", APP_ID)
    .order("nome");

  lista = data || [];
  render(lista);
}

/* RENDER CARDS */
function render(dados){
  const produtosEl = document.getElementById("produtos");

  produtosEl.innerHTML = dados.map(p=>{
    let primeiraImg = "";

    // Se houver array imagens, usa ele
    let imgs = [];
    if(p.imagens){
      imgs = typeof p.imagens === "string" ? JSON.parse(p.imagens) : p.imagens;
    } else if(p.imagem){
      imgs = [p.imagem]; // fallback para produtos antigos
    }

    primeiraImg = imgs[0] ? `<img src="${imgs[0]}">` : "";

    return `
    <div class="card" onclick='abrirGaleria(${JSON.stringify(imgs)})'>
      ${primeiraImg}
      <div class="nome">${p.nome}</div>
      <div class="preco">R$ ${p.preco.toFixed(2)}</div>
      <small>${p.categoria}</small><br>
      <small>${(p.tamanhos||[]).join(", ")} | ${(p.cores||[]).join(", ")}</small>
      <button class="botao" onclick="event.stopPropagation(); comprar('${p.nome}')">Comprar</button>
    </div>
    `;
  }).join("");
}

/* FILTRO */
function filtrar(){
  const txt = busca.value.toLowerCase();
  const cat = categoria.value;

  render(lista.filter(p =>
    (!txt || p.nome.toLowerCase().includes(txt)) &&
    (!cat || p.categoria === cat)
  ));
}

/* COMPRAR */
function comprar(nome){
  alert(`Produto selecionado: ${nome}\nIntegra√ß√£o com WhatsApp depois`);
}

/* GALERIA */
function abrirGaleria(imagens){
  if(!imagens) return;
  if(typeof imagens === "string"){
    try{ imagens = JSON.parse(imagens); } catch(e){ return; }
  }
  if(!Array.isArray(imagens) || !imagens.length) return;

  galeria.innerHTML = imagens.map(img=>`<img src="${img}">`).join("");
  modal.style.display = "flex";
}

function fecharModal(e){
  if(e && e.target.id !== "modal") return;
  modal.style.display = "none";
}

/* INIT */
carregarConfig();
carregarProdutos();
</script>

</body>
</html>
