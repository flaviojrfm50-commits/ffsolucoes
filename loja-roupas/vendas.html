<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== ESTILO BASE (INALTERADO) ===== */
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#020617;color:#fff}
:root{--cor-primaria:#22c55e;--cor-banner:#0f172a;--cor-card:#0f172a}
.banner{width:100%;height:260px;background:var(--cor-banner)}
.banner img{width:100%;height:100%;object-fit:cover}
.topo{padding:24px;text-align:center;background:var(--cor-banner)}
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:var(--cor-card);border-radius:14px;padding:12px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--cor-primaria);font-weight:bold;cursor:pointer}
#carrinhoBtn{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#000;border:none;border-radius:50%;width:60px;height:60px;font-size:22px}
#badge{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;border-radius:50%;padding:2px 7px;font-size:12px;display:none}

/* ===== CARD INDICA√á√ÉO ===== */
.card-ref{
  border:2px dashed #22c55e;
  background:#052e16;
}
.card-ref h3{margin:0 0 6px}
.card-ref p{font-size:14px;opacity:.9}

/* ===== MODAL + FORM (INALTERADO) ===== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center}
.modal-content{background:#020617;padding:20px;border-radius:16px;width:420px;max-width:95%}
.item{display:flex;justify-content:space-between;margin-bottom:6px}
.item button{background:#ef4444;border:none;border-radius:6px;color:#fff;padding:2px 8px}
.form-finalizacao{background:linear-gradient(180deg,#dcfce7,#bbf7d0);color:#064e3b;padding:18px;border-radius:18px;margin-top:14px}
.form-finalizacao input,.form-finalizacao select{width:100%;margin-bottom:10px;padding:12px;border-radius:12px;border:1px solid #86efac}
</style>
</head>

<body>

<div id="banner" class="banner"></div>
<div class="topo">
  <h1 id="nomeLoja"></h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">üõí <span id="badge">0</span></button>

<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Carrinho</h3>
    <div id="listaCarrinho"></div>
    <p><b>Total:</b> R$ <span id="total"></span></p>

    <!-- FORMUL√ÅRIO ORIGINAL (INALTERADO) -->
    <div class="form-finalizacao">
      <input id="cliNome" placeholder="Nome completo">
      <input id="cliCpf" placeholder="CPF">
      <input id="cliEndereco" placeholder="Endere√ßo">
      <input id="cliReferencia" placeholder="Ponto de refer√™ncia">

      <button class="botao" onclick="enviarLocalizacao()">üìç Usar minha localiza√ß√£o</button>

      <select id="pagamento">
        <option>PIX</option>
        <option>Cart√£o</option>
        <option>Dinheiro</option>
      </select>

      <input id="trocoValor" placeholder="Troco para quanto?">

      <button class="botao" onclick="finalizar()">üí¨ Enviar pedido no WhatsApp</button>
    </div>

    <button class="botao" style="background:#ef4444" onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const sb = supabase.createClient("https://pdajixsoowcyhnjwhgpc.supabase.co","sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw");
const params = new URLSearchParams(location.search);
const APP_ID = params.get("app");
const REF = params.get("ref");
if(REF) localStorage.setItem("ref_"+APP_ID, REF);

let carrinho = JSON.parse(localStorage.getItem("carrinho_"+APP_ID))||[];
let CLIENTE = JSON.parse(localStorage.getItem("cliente_"+APP_ID))||{};
let WHATS="",NOME_LOJA="";

/* ===== INIT ===== */
async function init(){
  const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",APP_ID).single();
  NOME_LOJA=cfg.nome_site; WHATS=cfg.whatsapp;
  nomeLoja.innerText=cfg.nome_site; descLoja.innerText=cfg.descricao_site||"";
  banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

  const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",APP_ID);

  produtos.innerHTML=`
    <div class="card card-ref">
      <h3>üîó Compartilhe nossa loja</h3>
      <p>Compartilhe seu link e ganhe <b>5% de desconto</b> quando algu√©m comprar.</p>
      <button class="botao" onclick="compartilhar()">Compartilhar meu link</button>
    </div>
  `+data.map(p=>`
    <div class="card">
      <img src="${p.imagem}">
      <b>${p.nome}</b><br>
      R$ ${p.preco.toFixed(2)}
      <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
    </div>
  `).join("");

  atualizarBadge();
}
init();

/* ===== INDICA√á√ÉO ===== */
function compartilhar(){
  const ref=(CLIENTE.nome||"cliente"+Date.now()).replace(/\s+/g,'').toLowerCase();
  const link=`${location.origin}${location.pathname}?app=${APP_ID}&ref=${ref}`;
  window.open(`https://wa.me/?text=${encodeURIComponent("üî• Compre nessa loja e ganhe desconto!\n"+link)}`);
}

/* ===== CARRINHO ===== */
function add(p){const i=carrinho.find(x=>x.id==p.id);i?i.qtd++:carrinho.push({...p,qtd:1});salvar()}
function salvar(){localStorage.setItem("carrinho_"+APP_ID,JSON.stringify(carrinho));atualizarBadge()}
function atualizarBadge(){const t=carrinho.reduce((s,i)=>s+i.qtd,0);badge.innerText=t;badge.style.display=t?"block":"none"}
function abrirCarrinho(){modal.style.display="flex";renderCarrinho()}
function fecharCarrinho(){modal.style.display="none"}
function renderCarrinho(){
  let sub=carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
  let ref=localStorage.getItem("ref_"+APP_ID);
  let desc=ref?sub*0.05:0;
  total.innerText=(sub-desc).toFixed(2);
  listaCarrinho.innerHTML=carrinho.map(i=>`${i.nome} x${i.qtd}`).join("<br>");
}

/* ===== FINALIZAR ===== */
function finalizar(){
  let msg=`üõçÔ∏è *${NOME_LOJA.toUpperCase()}*\n\n`;
  msg+=`üë§ *Cliente:* *${cliNome.value}*\nüè† *Endere√ßo:* ${cliEndereco.value}\n`;
  carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);
  msg+=`\nüí∞ *Total:* R$ ${total.innerText}`;
  const ref=localStorage.getItem("ref_"+APP_ID);
  if(ref) msg+=`\nüéÅ *Desconto por indica√ß√£o aplicado*`;
  window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);
}
</script>

</body>
</html>
