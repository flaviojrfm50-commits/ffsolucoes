<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#020617;color:#fff}
:root{--cor-primaria:#22c55e;--cor-banner:#0f172a;--cor-card:#0f172a}

/* banner */
.banner{width:100%;height:260px;background:var(--cor-banner)}
.banner img{width:100%;height:100%;object-fit:cover}

/* topo */
.topo{padding:24px;text-align:center;background:var(--cor-banner)}
.topo h1{margin:0}
.topo p{opacity:.8}

/* grid */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:var(--cor-card);border-radius:14px;padding:12px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--cor-primaria);font-weight:bold;cursor:pointer}

/* card indica√ß√£o */
.card-ref{border:2px dashed #22c55e;background:#052e16}
.card-ref p{font-size:14px;opacity:.9}

/* carrinho bot√£o */
#carrinhoBtn{
  position:fixed;bottom:20px;right:20px;
  background:#22c55e;color:#000;
  border:none;border-radius:50%;
  width:60px;height:60px;font-size:22px
}
#badge{
  position:absolute;top:-5px;right:-5px;
  background:#ef4444;color:#fff;
  border-radius:50%;padding:2px 7px;
  font-size:12px;display:none
}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:999}
.modal-content{background:#020617;padding:20px;border-radius:16px;width:420px;max-width:95%}

/* carrinho itens */
.item{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.item button{border:none;border-radius:6px;padding:2px 8px;font-size:14px;cursor:pointer}
.item .menos{background:#ef4444;color:#fff}
.item .mais{background:#22c55e;color:#000}

/* formul√°rio verde (mantido) */
.form-finalizacao{
  background:linear-gradient(180deg,#dcfce7,#bbf7d0);
  color:#064e3b;
  padding:18px;border-radius:18px;margin-top:14px
}
.form-finalizacao input,
.form-finalizacao select{
  width:100%;margin-bottom:10px;padding:12px;
  border-radius:12px;border:1px solid #86efac
}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
  <h1 id="nomeLoja"></h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">üõí <span id="badge">0</span></button>

<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Carrinho</h3>

    <div id="listaCarrinho"></div>
    <p><b>Total:</b> R$ <span id="total">0.00</span></p>

    <!-- FORMUL√ÅRIO (INALTERADO) -->
    <div class="form-finalizacao">
      <input id="cliNome" placeholder="Nome completo">
      <input id="cliCpf" placeholder="CPF">
      <input id="cliEndereco" placeholder="Endere√ßo">
      <input id="cliReferencia" placeholder="Ponto de refer√™ncia">

      <button class="botao" type="button" onclick="enviarLocalizacao()">
        üìç Usar minha localiza√ß√£o
      </button>

      <select id="pagamento" onchange="troco()">
        <option>PIX</option>
        <option>Cart√£o</option>
        <option>Dinheiro</option>
      </select>

      <input id="trocoValor" placeholder="Troco para quanto?" style="display:none">

      <button class="botao" onclick="finalizar()">üí¨ Enviar pedido no WhatsApp</button>
    </div>

    <button class="botao" style="background:#ef4444" onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ===== APP / REF ===== */
const params = new URLSearchParams(location.search);
const APP_ID = params.get("app");
const REF = params.get("ref");
if(!APP_ID){ document.body.innerHTML="Link inv√°lido"; throw new Error(); }
if(REF) localStorage.setItem("ref_"+APP_ID, REF);

/* ===== ESTADO ===== */
let carrinho = JSON.parse(localStorage.getItem("carrinho_"+APP_ID)) || [];
let CLIENTE = JSON.parse(localStorage.getItem("cliente_"+APP_ID)) || {};
let WHATS="", NOME_LOJA="";

/* ===== INIT ===== */
async function init(){
  const {data:cfg}=await sb.from("config_site")
    .select("nome_site,descricao_site,banner_url,whatsapp")
    .eq("app_id",APP_ID).single();

  NOME_LOJA = cfg.nome_site;
  WHATS = cfg.whatsapp;
  nomeLoja.innerText = cfg.nome_site;
  descLoja.innerText = cfg.descricao_site || "";
  banner.innerHTML = cfg.banner_url ? `<img src="${cfg.banner_url}">` : "";

  const {data}=await sb.from("produtos")
    .select("*").eq("ativo",true).eq("app_id",APP_ID);

  produtos.innerHTML = `
    <div class="card card-ref">
      <h3>üîó Indique a ${NOME_LOJA}</h3>
      <p>Ap√≥s a compra voc√™ receber√° um link exclusivo para indicar a loja e ganhar desconto.</p>
    </div>
  ` + data.map(p=>`
    <div class="card">
      <img src="${p.imagem}">
      <b>${p.nome}</b><br>
      R$ ${p.preco.toFixed(2)}
      <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
    </div>
  `).join("");

  atualizarBadge();
}
init();

/* ===== CARRINHO ===== */
function add(p){
  const id=String(p.id);
  const item=carrinho.find(i=>String(i.id)===id);
  item ? item.qtd++ : carrinho.push({...p,id,qtd:1});
  salvar(); renderCarrinho();
}

function remover(id){
  id=String(id);
  const item=carrinho.find(i=>String(i.id)===id);
  if(!item) return;
  item.qtd--;
  if(item.qtd<=0) carrinho=carrinho.filter(i=>String(i.id)!==id);
  salvar(); renderCarrinho();
}

function salvar(){
  localStorage.setItem("carrinho_"+APP_ID,JSON.stringify(carrinho));
  atualizarBadge();
}

function atualizarBadge(){
  const t=carrinho.reduce((s,i)=>s+i.qtd,0);
  badge.innerText=t;
  badge.style.display=t>0?"block":"none";
}

/* ===== MODAL ===== */
function abrirCarrinho(){ modal.style.display="flex"; renderCarrinho(); }
function fecharCarrinho(){ modal.style.display="none"; }

function renderCarrinho(){
  let subtotal=0;
  listaCarrinho.innerHTML=carrinho.map(i=>{
    subtotal+=i.preco*i.qtd;
    return `
      <div class="item">
        <span>${i.nome}</span>
        <div>
          <button class="menos" onclick="remover('${i.id}')">‚ûñ</button>
          <span>${i.qtd}</span>
          <button class="mais" onclick='add(${JSON.stringify(i)})'>‚ûï</button>
        </div>
      </div>
    `;
  }).join("");

  const ref=localStorage.getItem("ref_"+APP_ID);
  const desconto=ref?subtotal*0.05:0;
  total.innerText=(subtotal-desconto).toFixed(2);
}

/* ===== PAGAMENTO ===== */
function troco(){
  trocoValor.style.display = pagamento.value==="Dinheiro"?"block":"none";
}

/* ===== LOCALIZA√á√ÉO ===== */
function enviarLocalizacao(){
  navigator.geolocation.getCurrentPosition(pos=>{
    CLIENTE.localizacao=`https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
    localStorage.setItem("cliente_"+APP_ID,JSON.stringify(CLIENTE));
    alert("Localiza√ß√£o capturada ‚úî");
  });
}

/* ===== LINK INDICA√á√ÉO ===== */
function gerarLinkIndicacao(){
  const base=`${location.origin}${location.pathname}`;
  const id=(CLIENTE.nome||"cliente"+Date.now()).replace(/\s+/g,'').toLowerCase();
  return `${base}?app=${APP_ID}&ref=${id}`;
}

/* ===== FINALIZAR ===== */
function finalizar(){
  CLIENTE={
    nome:cliNome.value,
    cpf:cliCpf.value,
    endereco:cliEndereco.value,
    referencia:cliReferencia.value,
    localizacao:CLIENTE.localizacao||"n√£o enviada"
  };
  localStorage.setItem("cliente_"+APP_ID,JSON.stringify(CLIENTE));

  let msg=`üõçÔ∏è *${NOME_LOJA.toUpperCase()}*\n\n`;
  msg+=`üë§ *Cliente:* *${CLIENTE.nome}*\n`;
  msg+=`üè† *Endere√ßo:* ${CLIENTE.endereco}\n`;
  if(CLIENTE.referencia) msg+=`üìå *Refer√™ncia:* ${CLIENTE.referencia}\n`;
  msg+=`üìç *Localiza√ß√£o:* ${CLIENTE.localizacao}\n\n`;

  msg+=`üßæ *Itens do pedido*\n`;
  carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);

  msg+=`\nüí∞ *Total:* R$ ${total.innerText}\n`;
  msg+=`üí≥ *Pagamento:* ${pagamento.value}\n`;

  const linkIndicacao=gerarLinkIndicacao();
  msg+=`\nüîó *Indique a ${NOME_LOJA} e ganhe desconto*`;
  msg+=`\n${linkIndicacao}`;

  window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);

  localStorage.removeItem("carrinho_"+APP_ID);
  carrinho=[]; atualizarBadge(); fecharCarrinho();
}
</script>

</body>
</html>
