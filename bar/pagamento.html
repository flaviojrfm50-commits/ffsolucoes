<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fechar Conta</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:auto;padding:30px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.row{display:flex;gap:12px;flex-wrap:wrap}
input,select,textarea,button{
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
}
textarea{resize:vertical}
button{background:#22c55e;font-weight:bold;cursor:pointer}
button.sec{background:#1e293b;color:#fff}
.item{display:flex;justify-content:space-between;border-bottom:1px solid #1e293b;padding:6px 0}
.total{font-size:20px;font-weight:bold}
.pago{color:#22c55e}
.falta{color:#ef4444}
</style>
</head>

<body>

<div class="container">

<h2>ðŸ§¾ Fechar Conta</h2>

<div class="box">
  <h3>Consumo</h3>
  <div id="itens"></div>
  <p class="total">Total: R$ <span id="totalPedido">0.00</span></p>
</div>

<div class="box">
  <h3>Pagamentos</h3>

  <div class="row">
    <select id="tipo" onchange="tipoChanged()">
      <option value="pix">Pix</option>
      <option value="debito">DÃ©bito</option>
      <option value="credito">CrÃ©dito</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="fiado">Fiado</option>
    </select>

    <input type="number" id="valor" placeholder="Valor" step="0.01">
    <input id="cliente" placeholder="Nome do cliente (fiado)" style="display:none">
    <button onclick="addPagamento()">Adicionar</button>
  </div>

  <div id="listaPagamentos"></div>

  <p class="pago">Pago: R$ <span id="totalPago">0.00</span></p>
  <p class="falta">Falta: R$ <span id="falta">0.00</span></p>
  <p class="pago">Troco: R$ <span id="troco">0.00</span></p>

  <textarea id="obs" placeholder="ObservaÃ§Ã£o"
    style="width:100%;margin-top:10px"></textarea>
</div>

<div class="box">
  <button onclick="confirmarFechamento()">Fechar Conta</button>
</div>

<div class="box">
  <button onclick="voltarAdicionar()">âž• Adicionar mais itens</button>
  <button class="sec" onclick="location.href='mesas.html'">Voltar</button>
</div>

</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const pedidoId = new URLSearchParams(location.search).get("pedido");

let totalPedido = 0;
let pagamentos = [];
let mesaId = null;
let numeroMesa = null;

const tipoSelect   = document.getElementById("tipo");
const valorInput   = document.getElementById("valor");
const clienteInput = document.getElementById("cliente");
const obsInput     = document.getElementById("obs");

/* ===== CONSUMO ===== */
async function carregarItens(){
  const { data } = await sb
    .from("pedido_itens")
    .select("nome_produto, preco, quantidade")
    .eq("app_id", admin.app_id)
    .eq("pedido_id", pedidoId);

  totalPedido = 0;
  const div = document.getElementById("itens");
  div.innerHTML = "";

  (data||[]).forEach(i=>{
    const sub = i.preco * i.quantidade;
    totalPedido += sub;
    div.innerHTML += `
      <div class="item">
        <span>${i.quantidade}x ${i.nome_produto}</span>
        <span>R$ ${sub.toFixed(2)}</span>
      </div>`;
  });

  document.getElementById("totalPedido").innerText = totalPedido.toFixed(2);
}

/* ===== PEDIDO / MESA ===== */
async function carregarPedido(){
  const { data } = await sb
    .from("pedidos")
    .select("mesa_id, mesas(numero_mesa)")
    .eq("id", pedidoId)
    .eq("app_id", admin.app_id)
    .single();

  mesaId = data?.mesa_id || null;
  numeroMesa = data?.mesas?.numero_mesa || null;
}

/* ===== TIPO ===== */
function tipoChanged(){
  clienteInput.style.display =
    tipoSelect.value === "fiado" ? "block" : "none";
  if(tipoSelect.value !== "fiado") clienteInput.value = "";
}

/* ===== PAGAMENTOS ===== */
async function carregarPagamentos(){
  const { data } = await sb
    .from("pagamentos")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("pedido_id", pedidoId);

  pagamentos = data || [];
  renderTotais();
}

function renderTotais(){
  let totalPago = 0;
  let dinheiro = 0;

  const div = document.getElementById("listaPagamentos");
  div.innerHTML = "";

  pagamentos.forEach(p=>{
    if(p.tipo !== "fiado"){
      totalPago += p.valor;
      if(p.tipo === "dinheiro") dinheiro += p.valor;
    }

    div.innerHTML += `
      <div class="item">
        <span>${p.tipo.toUpperCase()}
        ${p.cliente_fiado ? "â€¢ "+p.cliente_fiado : ""}</span>
        <span>R$ ${p.valor.toFixed(2)}</span>
      </div>`;
  });

  const falta = Math.max(0, totalPedido - totalPago);
  const troco = Math.max(0, dinheiro - totalPedido);

  document.getElementById("totalPago").innerText = totalPago.toFixed(2);
  document.getElementById("falta").innerText = falta.toFixed(2);
  document.getElementById("troco").innerText = troco.toFixed(2);
}

/* ===== ADD PAGAMENTO ===== */
async function addPagamento(){
  const tipo = tipoSelect.value;
  const valor = Number(valorInput.value);

  if(valor <= 0) return alert("Valor invÃ¡lido");
  if(tipo === "fiado" && !clienteInput.value.trim())
    return alert("Informe o cliente do fiado");

  await sb.from("pagamentos").insert({
    app_id: admin.app_id,
    pedido_id: pedidoId,
    tipo,
    valor,
    cliente_fiado: tipo==="fiado" ? clienteInput.value.trim() : null
  });

  valorInput.value = "";
  clienteInput.value = "";
  carregarPagamentos();
}

/* ===== FECHAR CONTA ===== */
async function confirmarFechamento(){
  const falta = Number(document.getElementById("falta").innerText);

  if(falta > 0 && !obsInput.value.trim()){
    alert("Informe a observaÃ§Ã£o do valor faltante");
    return;
  }

  await sb.from("pedidos").update({
    status:"fechado",
    observacao: obsInput.value || null
  }).eq("id", pedidoId).eq("app_id", admin.app_id);

  if(mesaId){
    await sb.from("mesas")
      .update({ ocupada:false })
      .eq("id", mesaId)
      .eq("app_id", admin.app_id);
  }

  alert("Conta fechada com sucesso âœ…");
  location.href = "mesas.html";
}

/* ===== VOLTAR ===== */
function voltarAdicionar(){
  if(numeroMesa){
    location.href = `mesa.html?mesa=${mesaId}&app_id=${admin.app_id}`;
  }
}

/* ===== START ===== */
carregarPedido();
carregarItens();
carregarPagamentos();
</script>

</body>
</html>
