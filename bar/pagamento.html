<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fechar Conta</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:auto;padding:30px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.row{display:flex;gap:12px;flex-wrap:wrap}
input,select,textarea,button{
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
}
textarea{resize:vertical}
button{background:#22c55e;font-weight:bold;cursor:pointer}
button.sec{background:#1e293b;color:#fff}
.item{display:flex;justify-content:space-between;border-bottom:1px solid #1e293b;padding:6px 0}
.total{font-size:20px;font-weight:bold}
.pago{color:#22c55e}
.falta{color:#ef4444}
</style>
</head>

<body>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin?.app_id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}

const pedidoId = new URLSearchParams(location.search).get("pedido");
if(!pedidoId){
  alert("Pedido n√£o informado");
  throw new Error("Pedido n√£o informado");
}

let totalPedido = 0;
let pagamentos = [];
let mesaId = null;
let numeroMesa = null;

let tipoSelect, valorInput, clienteInput, obsInput;
</script>

<div class="container">

<h2>üßæ Fechar Conta</h2>

<div class="box">
  <h3>Consumo</h3>
  <div id="itens"></div>
  <p class="total">Total: R$ <span id="totalPedido">0.00</span></p>
</div>

<div class="box">
  <h3>Pagamentos</h3>

  <div class="row">
    <select id="tipo" onchange="tipoChanged()">
      <option value="pix">Pix</option>
      <option value="debito">D√©bito</option>
      <option value="credito">Cr√©dito</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="fiado">Fiado</option>
    </select>

    <input type="number" id="valor" placeholder="Valor" step="0.01">
    <input id="cliente" placeholder="Nome do cliente (fiado)" style="display:none">
    <button onclick="addPagamento()">Adicionar</button>
  </div>

  <div id="listaPagamentos"></div>

  <p class="pago">Pago: R$ <span id="totalPago">0.00</span></p>
  <p class="falta">Falta: R$ <span id="falta">0.00</span></p>
  <p class="pago">Troco: R$ <span id="troco">0.00</span></p>

  <textarea id="obs" placeholder="Observa√ß√£o"
    style="width:100%;margin-top:10px"></textarea>
</div>

<div class="box">
  <button onclick="confirmarFechamento()">Fechar Conta</button>
</div>

<div class="box">
  <button onclick="voltarAdicionar()">‚ûï Adicionar mais itens</button>
  <button class="sec" onclick="location.href='mesas.html'">Voltar</button>
</div>

</div>

<script>
// ================= FECHAR =================
async function confirmarFechamento(){
  const falta = Number(document.getElementById("falta").innerText);
  const obs = obsInput.value.trim();

  if(falta > 0 && !obs){
    alert("Informe a observa√ß√£o do valor faltante");
    return;
  }

  await sb.from("pedidos").update({
    status:"fechado",
    observacao: obs || null
  }).eq("id", pedidoId).eq("app_id", admin.app_id);

  if(mesaId){
    await sb.from("mesas")
      .update({ ocupada: false })   // ‚úÖ CORRE√á√ÉO AQUI
      .eq("id", mesaId)
      .eq("app_id", admin.app_id);
  }

  alert("Conta fechada com sucesso ‚úÖ");
  location.href = "mesas.html?reload="+Date.now();
}
</script>

</body>
</html>
