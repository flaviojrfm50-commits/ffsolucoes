<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Login do Funcion√°rio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  background:#0f172a;
  padding:28px;
  border-radius:18px;
  width:100%;
  max-width:360px;
}
h2{
  margin-top:0;
  text-align:center;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
  border:none;
}
button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.msg{
  margin-top:12px;
  text-align:center;
  font-size:14px;
  color:#f87171;
}
small{
  display:block;
  text-align:center;
  opacity:.6;
  margin-top:10px;
}
</style>
</head>

<body>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= SESS√ÉO DO BAR ================= */
const admin = JSON.parse(localStorage.getItem("admin_logado"));

if(!admin || !admin.app_id){
  alert("Bar n√£o selecionado");
  location.href = "/super-admin.html";
}
</script>

<div class="card">
  <h2>üë§ Funcion√°rio</h2>

  <input id="nome" placeholder="Nome do funcion√°rio">
  <input id="pin" type="password" placeholder="PIN">

  <button onclick="entrar()">Entrar</button>

  <div class="msg" id="msg"></div>

  <small>Acesso interno do bar</small>
</div>

<script>
/* ================= PERMISS√ÉO ================= */
function exigirPermissao(tiposPermitidos){
  const admin = JSON.parse(localStorage.getItem("admin_logado"));
  const usuario = JSON.parse(localStorage.getItem("usuario_bar"));

  // admin do bar sempre pode
  if(admin && admin.tipo === "bar") return;

  if(!usuario){
    alert("Sess√£o expirada");
    location.href = "login-funcionario.html";
    return;
  }

  if(!tiposPermitidos.includes(usuario.tipo)){
    alert("Acesso n√£o autorizado");
    location.href = "login-funcionario.html";
  }
}

/* ================= LOGIN ================= */
async function entrar(){
  const nome = document.getElementById("nome").value.trim();
  const pin  = document.getElementById("pin").value.trim();
  const msg  = document.getElementById("msg");

  msg.innerText = "";

  if(!nome || !pin){
    msg.innerText = "Informe nome e PIN";
    return;
  }

  const { data, error } = await sb
    .from("usuarios")
    .select("id,nome,tipo,pin")
    .eq("app_id", admin.app_id)
    .eq("nome", nome)
    .eq("ativo", true)
    .maybeSingle();

  if(error){
    console.error(error);
    msg.innerText = "Erro ao validar usu√°rio";
    return;
  }

  if(!data){
    msg.innerText = "Usu√°rio n√£o encontrado";
    return;
  }

  if(String(data.pin) !== String(pin)){
    msg.innerText = "PIN incorreto";
    return;
  }

  // ‚úÖ salva sess√£o do funcion√°rio (PADR√ÉO √öNICO)
  localStorage.setItem("usuario_bar", JSON.stringify({
    id: data.id,
    nome: data.nome,
    tipo: data.tipo
  }));

  // üö¶ redireciona pelo tipo
  if(data.tipo === "garcom"){
    location.href = "mesas.html";
  }else if(data.tipo === "caixa"){
    location.href = "caixa.html";
  }else{
    msg.innerText = "Tipo de usu√°rio inv√°lido";
  }
}

/* Enter para login */
document.addEventListener("keydown", e=>{
  if(e.key === "Enter") entrar();
});
</script>

</body>
</html>
