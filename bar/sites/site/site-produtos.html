<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos do Site</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="admin.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.form{
  background:#0f172a;
  padding:20px;
  border-radius:18px;
  margin-bottom:24px;
}
.form input, .form textarea{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
}
.form button{
  margin-top:14px;
  background:#00b4ff;
  color:#000;
  border:none;
  padding:12px 18px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}

.lista{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.produto{
  background:#0f172a;
  padding:16px;
  border-radius:16px;
}
.produto img{
  width:100%;
  height:140px;
  object-fit:cover;
  border-radius:12px;
}
.produto h4{
  margin-top:10px;
}
.produto p{
  font-size:14px;
  opacity:.8;
}
.produto span{
  display:block;
  margin-top:6px;
  font-weight:700;
  color:#00b4ff;
}
</style>
</head>

<body>

<div class="topo">
  <h2>ðŸ§± Produtos do Site</h2>
  <button class="sair" onclick="voltar()">Voltar</button>
</div>

<div class="container">

  <!-- FORM -->
  <div class="form">
    <h3>Novo Produto em Destaque</h3>

    <input id="nome" placeholder="Nome do produto">
    <textarea id="descricao" placeholder="DescriÃ§Ã£o"></textarea>
    <input id="preco" placeholder="PreÃ§o (opcional)">
    <input type="file" id="imagem" accept="image/*">

    <button onclick="salvarProduto()">Salvar Produto</button>
  </div>

  <!-- LISTA -->
  <h3>Produtos em Destaque</h3>
  <div class="lista" id="listaProdutos"></div>

</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ===== SESSÃƒO ===== */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin || !admin.app_id){
  alert("SessÃ£o invÃ¡lida");
  location.href = "../auth/login.html";
}
const appId = admin.app_id;

/* ===== SALVAR ===== */
async function salvarProduto(){
  const nome = nomeInput.value;
  const desc = descricao.value;
  const preco = precoInput.value;
  const file = imagem.files[0];

  if(!nome || !desc || !file){
    alert("Preencha nome, descriÃ§Ã£o e imagem");
    return;
  }

  const filePath = `sites/${appId}/produtos/${Date.now()}.jpg`;

  await sb.storage.from("public").upload(filePath, file, {
    upsert:true,
    contentType:file.type
  });

  const url =
    `https://pdajixsoowcyhnjwhgpc.supabase.co/storage/v1/object/public/public/${filePath}`;

  await sb.from("site_produtos").insert({
    app_id: appId,
    nome,
    descricao: desc,
    preco,
    imagem: url
  });

  alert("Produto salvo");
  carregarProdutos();
}

/* ===== LISTAR ===== */
async function carregarProdutos(){
  const { data } = await sb
    .from("site_produtos")
    .select("*")
    .eq("app_id", appId)
    .order("id", { ascending:false });

  listaProdutos.innerHTML = "";

  data?.forEach(p => {
    listaProdutos.innerHTML += `
      <div class="produto">
        <img src="${p.imagem}">
        <h4>${p.nome}</h4>
        <p>${p.descricao}</p>
        ${p.preco ? `<span>${p.preco}</span>` : ""}
      </div>
    `;
  });
}

carregarProdutos();

/* ===== VOLTAR ===== */
function voltar(){
  location.href = "index.html";
}
</script>

</body>
</html>
