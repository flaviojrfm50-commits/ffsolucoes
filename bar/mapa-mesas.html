<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa das Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#020617;
  font-family:Arial;
  color:#fff;
  overflow:hidden;
}

.topo{
  background:#0f172a;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* wrapper com pan */
.mapa-wrapper{
  width:100%;
  height:calc(100vh - 64px);
  overflow:hidden;
  touch-action:none;
}

.mapa{
  position:relative;
  width:1200px;
  height:900px;
  transform-origin:0 0;
}

/* elementos */
.bar,.mesa{
  position:absolute;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
}

.bar{
  width:160px;
  height:180px;
  border:3px solid #ef4444;
}

.mesa{
  width:60px;
  height:60px;
  border:3px solid #22c55e;
}

.bar:active,.mesa:active{
  cursor:grabbing;
}
</style>
</head>

<body>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = funcionario?.app_id || admin?.app_id;

if(!app_id){
  alert("Sess√£o inv√°lida");
  location.href="../auth/login.html";
}

const podeEditar = !!admin; // admin edita no mobile e desktop
</script>

<div class="topo">
  <h3>üó∫Ô∏è Mapa das Mesas</h3>
  <button onclick="history.back()">Voltar</button>
</div>

<div class="mapa-wrapper" id="wrapper">
  <div class="mapa" id="mapa">
    <div class="bar" id="bar">BAR</div>
  </div>
</div>

<script>
const mapa = document.getElementById("mapa");
const wrapper = document.getElementById("wrapper");

/* ===== PAN DO MAPA (1 dedo) ===== */
let panX=0, panY=0, panAtivo=false, startX=0, startY=0;
const scale = window.innerWidth <= 768 ? 0.7 : 1;

wrapper.addEventListener("touchstart",e=>{
  if(e.touches.length!==1) return;
  panAtivo=true;
  startX=e.touches[0].clientX-panX;
  startY=e.touches[0].clientY-panY;
});

wrapper.addEventListener("touchmove",e=>{
  if(!panAtivo) return;
  panX=e.touches[0].clientX-startX;
  panY=e.touches[0].clientY-startY;
  mapa.style.transform=`translate(${panX}px,${panY}px) scale(${scale})`;
});

wrapper.addEventListener("touchend",()=>panAtivo=false);

/* ===== DRAG ELEMENTOS (ADMIN) ===== */
function drag(el, config){
  if(!podeEditar) return;

  let ativo=false, offX=0, offY=0;

  const start=(x,y)=>{
    ativo=true;
    const r=el.getBoundingClientRect();
    offX=x-r.left;
    offY=y-r.top;
  };

  const move=(x,y)=>{
    if(!ativo) return;
    el.style.left=(x-offX-panX)/scale+"px";
    el.style.top =(y-offY-64-panY)/scale+"px";
  };

  const end=async()=>{
    if(!ativo) return;
    ativo=false;

    const { tipo, mesa_id } = config;

    let q = sb.from("mapa_mesas")
      .select("id")
      .eq("app_id",app_id)
      .eq("tipo",tipo);

    if(tipo==="MESA") q=q.eq("mesa_id",mesa_id);

    const { data } = await q.maybeSingle();

    if(data){
      await sb.from("mapa_mesas")
        .update({x:el.style.left,y:el.style.top})
        .eq("id",data.id);
    }else{
      await sb.from("mapa_mesas")
        .insert({
          app_id,
          tipo,
          mesa_id: tipo==="MESA"?mesa_id:null,
          x:el.style.left,
          y:el.style.top
        });
    }
  };

  /* mouse */
  el.addEventListener("mousedown",e=>start(e.clientX,e.clientY));
  document.addEventListener("mousemove",e=>move(e.clientX,e.clientY));
  document.addEventListener("mouseup",end);

  /* touch */
  el.addEventListener("touchstart",e=>{
    if(e.touches.length!==1) return;
    start(e.touches[0].clientX,e.touches[0].clientY);
    e.stopPropagation(); // impede pan do mapa
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(e.touches.length!==1) return;
    move(e.touches[0].clientX,e.touches[0].clientY);
    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchend",end);
}

/* ===== BAR ===== */
async function carregarBar(){
  const bar=document.getElementById("bar");

  const { data } = await sb.from("mapa_mesas")
    .select("x,y")
    .eq("app_id",app_id)
    .eq("tipo","BAR")
    .maybeSingle();

  if(data){
    bar.style.left=data.x;
    bar.style.top =data.y;
  }else{
    bar.style.left="40px";
    bar.style.top ="140px";
  }

  drag(bar,{tipo:"BAR",mesa_id:null});
}

/* ===== MESAS ===== */
async function carregarMesas(){
  const { data: mesas } = await sb
    .from("mesas")
    .select("id,numero_mesa")
    .eq("app_id",app_id)
    .eq("ativa",true)
    .order("numero_mesa");

  const { data: pos } = await sb
    .from("mapa_mesas")
    .select("mesa_id,x,y")
    .eq("app_id",app_id)
    .eq("tipo","MESA");

  const mapaPos={};
  (pos||[]).forEach(p=>mapaPos[p.mesa_id]=p);

  let x=260,y=60,col=0;

  mesas.forEach(m=>{
    const d=document.createElement("div");
    d.className="mesa";
    d.innerText=m.numero_mesa;

    if(mapaPos[m.id]){
      d.style.left=mapaPos[m.id].x;
      d.style.top =mapaPos[m.id].y;
    }else{
      d.style.left=x+"px";
      d.style.top =y+"px";
    }

    mapa.appendChild(d);
    drag(d,{tipo:"MESA",mesa_id:m.id});

    col++; x+=80;
    if(col>=4){col=0;x=260;y+=90;}
  });
}

/* START */
carregarBar();
carregarMesas();
</script>

</body>
</html>
