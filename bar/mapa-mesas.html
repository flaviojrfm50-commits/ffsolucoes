<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa das Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#020617;
  font-family:Arial;
  color:#fff;
}

.topo{
  background:#0f172a;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.mapa{
  position:relative;
  width:100%;
  height:calc(100vh - 64px);
  background:#020617;
  overflow:hidden;
}

/* BAR */
.bar{
  position:absolute;
  width:160px;
  height:180px;
  border:3px solid #ef4444;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  cursor:grab;
  user-select:none;
}

/* MESA */
.mesa{
  position:absolute;
  width:60px;
  height:60px;
  border-radius:12px;
  border:3px solid #22c55e;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  cursor:grab;
  user-select:none;
}

.mesa:active,
.bar:active{
  cursor:grabbing;
}
</style>
</head>

<body>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = funcionario?.app_id || admin?.app_id;

if(!app_id){
  alert("Sess√£o inv√°lida");
  location.href="../auth/login.html";
}
</script>

<div class="topo">
  <h3>üó∫Ô∏è Mapa das Mesas</h3>
  <button onclick="history.back()">Voltar</button>
</div>

<div class="mapa" id="mapa">
  <div class="bar" id="bar" style="left:40px;top:140px;">BAR</div>
</div>

<script>
const mapa = document.getElementById("mapa");

/* üîπ Drag gen√©rico */
function drag(el){
  let offX=0, offY=0, ativo=false;

  el.addEventListener("mousedown",e=>{
    ativo=true;
    offX=e.offsetX;
    offY=e.offsetY;
  });

  document.addEventListener("mousemove",e=>{
    if(!ativo) return;
    el.style.left=(e.pageX-offX)+"px";
    el.style.top=(e.pageY-offY-64)+"px";
  });

  document.addEventListener("mouseup",()=>ativo=false);
}

/* BAR arrast√°vel */
drag(document.getElementById("bar"));

/* üîπ Carrega mesas reais */
async function carregarMesas(){
  const { data: mesas } = await sb
    .from("mesas")
    .select("id,numero_mesa")
    .eq("app_id",app_id)
    .eq("ativa",true)
    .order("numero_mesa");

  let x=260, y=60;
  const maxCol=4;
  let col=0;

  mesas.forEach(m=>{
    const div=document.createElement("div");
    div.className="mesa";
    div.innerText=m.numero_mesa;
    div.style.left=x+"px";
    div.style.top=y+"px";

    mapa.appendChild(div);
    drag(div);

    col++;
    x+=80;
    if(col>=maxCol){
      col=0;
      x=260;
      y+=90;
    }
  });
}

carregarMesas();
</script>

</body>
</html>
