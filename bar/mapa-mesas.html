<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa das Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#020617;
  font-family:Arial;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.mapa{
  position:relative;
  width:100%;
  height:calc(100vh - 64px);
  overflow:hidden;
}
.bar,.mesa{
  position:absolute;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  cursor:grab;
  user-select:none;
}
.bar{
  width:160px;
  height:180px;
  border:3px solid #ef4444;
}
.mesa{
  width:60px;
  height:60px;
  border:3px solid #22c55e;
}
.bar:active,.mesa:active{cursor:grabbing}
</style>
</head>

<body>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = funcionario?.app_id || admin?.app_id;

if(!app_id){
  alert("Sess√£o inv√°lida");
  location.href="../auth/login.html";
}

const modoAdmin = !!admin;
</script>

<div class="topo">
  <h3>üó∫Ô∏è Mapa das Mesas</h3>
  <button onclick="history.back()">Voltar</button>
</div>

<div class="mapa" id="mapa">
  <div class="bar" id="bar" style="left:40px;top:140px;">BAR</div>
</div>

<script>
const mapa = document.getElementById("mapa");

/* üíé DRAG COM SALVAMENTO SEGURO */
function drag(el, mesa_id){
  if(!modoAdmin) return;

  let ativo=false, offX=0, offY=0;

  el.addEventListener("mousedown",e=>{
    ativo=true;
    offX=e.offsetX;
    offY=e.offsetY;
  });

  document.addEventListener("mousemove",e=>{
    if(!ativo) return;
    el.style.left=(e.pageX-offX)+"px";
    el.style.top =(e.pageY-offY-64)+"px";
  });

  document.addEventListener("mouseup",async()=>{
    if(!ativo) return;
    ativo=false;

    if(!mesa_id) return; // ‚ùå n√£o salva BAR

    /* üîé verifica se j√° existe */
    const { data: existe, error: erroBusca } = await sb
      .from("mapa_mesas")
      .select("id")
      .eq("app_id",app_id)
      .eq("mesa_id",mesa_id)
      .maybeSingle();

    if(erroBusca){
      console.error("Erro busca:", erroBusca);
      return;
    }

    if(existe){
      /* üîÅ UPDATE */
      const { error } = await sb
        .from("mapa_mesas")
        .update({
          x: el.style.left,
          y: el.style.top
        })
        .eq("id", existe.id);

      if(error){
        console.error("Erro update:", error);
      }

    }else{
      /* ‚ûï INSERT */
      const { error } = await sb
        .from("mapa_mesas")
        .insert({
          app_id,
          mesa_id,
          x: el.style.left,
          y: el.style.top
        });

      if(error){
        console.error("Erro insert:", error);
      }
    }
  });
}

/* üîπ BAR arrast√°vel (visual apenas) */
drag(document.getElementById("bar"), "BAR");

/* üîπ CARREGA MESAS + POSI√á√ïES */
async function carregarMesas(){

  const { data: mesas } = await sb
    .from("mesas")
    .select("id,numero_mesa")
    .eq("app_id",app_id)
    .eq("ativa",true)
    .order("numero_mesa");

  const { data: posicoes } = await sb
    .from("mapa_mesas")
    .select("mesa_id,x,y")
    .eq("app_id",app_id);

  const mapaPos = {};
  (posicoes||[]).forEach(p=>{
    mapaPos[p.mesa_id] = p;
  });

  let x=260,y=60,col=0;

  mesas.forEach(m=>{
    const div=document.createElement("div");
    div.className="mesa";
    div.innerText=m.numero_mesa;

    if(mapaPos[m.id]){
      div.style.left = mapaPos[m.id].x;
      div.style.top  = mapaPos[m.id].y;
    }else{
      div.style.left = x+"px";
      div.style.top  = y+"px";
    }

    mapa.appendChild(div);
    drag(div, m.id);

    col++; x+=80;
    if(col>=4){
      col=0;
      x=260;
      y+=90;
    }
  });
}

carregarMesas();
</script>

</body>
</html>
