<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{
  background:#0f172a;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
.container{max-width:1200px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:16px
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:14px
}

.valor{font-size:22px;font-weight:bold}
.tipo{font-size:13px;color:#94a3b8}
.total{font-size:26px;font-weight:bold}

.positivo{color:#22c55e}
.negativo{color:#ef4444}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #1e293b;font-size:14px}
th{color:#94a3b8}

button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  font-weight:bold;
  cursor:pointer
}
button.sec{background:#1e293b;color:#fff}
button.alerta{background:#eab308;color:#000}

.badge{
  background:#ef4444;
  color:#fff;
  border-radius:999px;
  padding:2px 8px;
  font-size:12px;
  margin-left:6px
}

small{color:#94a3b8}
</style>
</head>

<body>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin?.app_id){
  alert("SessÃ£o expirada");
  location.href="../auth/login.html";
}
</script>

<div class="topo">
  <h2>ðŸ’° Caixa</h2>
  <div>
    <button onclick="location.href='venda-avulsa.html'">âž• Venda Avulsa</button>

    <button class="alerta" id="btnContas" style="display:none" onclick="mostrarContas()">
      ðŸ”” Contas <span class="badge" id="qtdContas">0</span>
    </button>

    <button class="sec" onclick="location.href='historico.html'">ðŸ“Š HistÃ³rico</button>
    <button class="sec" onclick="location.href='admin.html'">Voltar</button>
  </div>
</div>

<div class="container">

<!-- CONTAS PENDENTES -->
<div class="box" id="boxContas" style="display:none">
  <h3>ðŸ§¾ Mesas aguardando pagamento</h3>
  <table>
    <thead>
      <tr>
        <th>Mesa</th>
        <th>Total</th>
        <th>Forma sugerida</th>
        <th>AÃ§Ã£o</th>
      </tr>
    </thead>
    <tbody id="listaContas"></tbody>
  </table>
</div>

<!-- RESUMO -->
<div class="grid">
  <div class="card"><div class="tipo">Dinheiro</div><div class="valor positivo" id="tDinheiro">R$ 0,00</div></div>
  <div class="card"><div class="tipo">Pix</div><div class="valor positivo" id="tPix">R$ 0,00</div></div>
  <div class="card"><div class="tipo">DÃ©bito</div><div class="valor positivo" id="tDebito">R$ 0,00</div></div>
  <div class="card"><div class="tipo">CrÃ©dito</div><div class="valor positivo" id="tCredito">R$ 0,00</div></div>
  <div class="card"><div class="tipo">Fiado</div><div class="valor negativo" id="tFiado">R$ 0,00</div></div>
</div>

<!-- MOVIMENTAÃ‡Ã•ES -->
<div class="box">
  <h3>ðŸ“‹ MovimentaÃ§Ãµes</h3>
  <table>
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Valor</th>
        <th>Pedido</th>
        <th>Obs</th>
      </tr>
    </thead>
    <tbody id="listaMov"></tbody>
  </table>
</div>

<div class="box">
  <p class="total">
    Total em caixa: R$ <span id="totalCaixa">0.00</span><br>
    <small class="negativo">Fiado pendente: R$ <span id="totalFiado">0.00</span></small>
  </p>
</div>

</div>

<script>
/* ===== CONTAS PENDENTES ===== */
async function verificarContas(){
  const { data } = await sb
    .from("pedidos")
    .select(`
      id,
      forma_pagamento_sugerida,
      mesas(numero_mesa),
      pedido_itens(preco,quantidade)
    `)
    .eq("app_id", admin.app_id)
    .in("status", ["conta_solicitada","aguardando_pagamento"]);

  const btn = document.getElementById("btnContas");
  const qtd = document.getElementById("qtdContas");
  const box = document.getElementById("boxContas");
  const lista = document.getElementById("listaContas");

  lista.innerHTML = "";

  if(data && data.length){
    btn.style.display = "inline-block";
    qtd.innerText = data.length;
    box.style.display = "block";

    data.forEach(p=>{
      let total = 0;
      p.pedido_itens.forEach(i=>{
        total += i.preco * i.quantidade;
      });

      lista.innerHTML += `
        <tr>
          <td>Mesa ${p.mesas.numero_mesa}</td>
          <td>R$ ${total.toFixed(2)}</td>
          <td>${p.forma_pagamento_sugerida?.toUpperCase() || "-"}</td>
          <td>
            <button onclick="irPagamento('${p.id}')">
              ðŸ’³ Ir para pagamento
            </button>
          </td>
        </tr>
      `;
    });
  } else {
    btn.style.display = "none";
    box.style.display = "none";
  }
}

function irPagamento(pedidoId){
  location.href = `pagamento.html?pedido=${pedidoId}&app_id=${admin.app_id}`;
}

function mostrarContas(){
  document.getElementById("boxContas")
    .scrollIntoView({ behavior:"smooth" });
}

/* ===== CAIXA FINANCEIRO ===== */
let pagamentos = [];
let pedidosMap = {};
let total = { dinheiro:0, pix:0, debito:0, credito:0, fiado:0 };

async function carregarCaixa(){
  const { data: pags } = await sb
    .from("pagamentos")
    .select("tipo,valor,pedido_id")
    .eq("app_id", admin.app_id)
    .order("created_at");

  pagamentos = pags || [];

  const { data: peds } = await sb
    .from("pedidos")
    .select("id,observacao,total")
    .eq("app_id", admin.app_id);

  pedidosMap = {};
  (peds||[]).forEach(p=>{
    pedidosMap[p.id] = {
      obs: p.observacao,
      total: Number(p.total) || 0
    };
  });

  renderCaixa();
}

function renderCaixa(){
  total = { dinheiro:0, pix:0, debito:0, credito:0, fiado:0 };
  const tbody = document.getElementById("listaMov");
  tbody.innerHTML = "";

  pagamentos.forEach(p=>{
    const tipo = p.tipo?.toLowerCase();
    let valor = Number(p.valor);

    if(tipo === "fiado" && (!valor || valor === 0)){
      valor = pedidosMap[p.pedido_id]?.total || 0;
    }

    if(total[tipo] !== undefined){
      total[tipo] += valor;
    }

    tbody.innerHTML += `
      <tr>
        <td>${p.tipo.toUpperCase()}</td>
        <td>R$ ${valor.toFixed(2)}</td>
        <td>${p.pedido_id ? "#" + p.pedido_id.slice(0,6) : "-"}</td>
        <td>${pedidosMap[p.pedido_id]?.obs || "-"}</td>
      </tr>
    `;
  });

  document.getElementById("tDinheiro").innerText = "R$ " + total.dinheiro.toFixed(2);
  document.getElementById("tPix").innerText = "R$ " + total.pix.toFixed(2);
  document.getElementById("tDebito").innerText = "R$ " + total.debito.toFixed(2);
  document.getElementById("tCredito").innerText = "R$ " + total.credito.toFixed(2);
  document.getElementById("tFiado").innerText = "R$ " + total.fiado.toFixed(2);

  const totalCaixa =
    total.dinheiro + total.pix + total.debito + total.credito;

  document.getElementById("totalCaixa").innerText = totalCaixa.toFixed(2);
  document.getElementById("totalFiado").innerText = total.fiado.toFixed(2);
}

/* START */
carregarCaixa();
verificarContas();
setInterval(verificarContas, 4000);
</script>

</body>
</html>
