<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cozinha</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#020617;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:16px;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.pedido{
  background:#0f172a;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  border-left:6px solid #1e293b;
}
.pedido.novo{
  border-left-color:#22c55e;
  box-shadow:0 0 18px rgba(34,197,94,.6);
}
.info{font-weight:bold;margin-bottom:6px;}
.origem{font-size:13px;color:#38bdf8;margin-bottom:6px;}
.tempo{font-size:13px;color:#facc15;margin-bottom:8px;}
.item{
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #1e293b;
  padding:4px 0;
}
.total{margin-top:8px;font-weight:bold;}
.acoes{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.btn-aceitar{background:#22c55e;color:#000;}
.btn-finalizar{background:#2563eb;color:#fff;}
.btn-print{background:#64748b;color:#fff;}
.btn-zap{background:#25d366;color:#000;}
.btn-excluir{background:#dc2626;color:#fff;}
</style>
</head>

<body>

<div class="topo">
  <h2>Pedidos da Cozinha</h2>
</div>

<div class="container" id="lista">
  Carregando pedidos‚Ä¶
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= ADMIN ================= */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin || !admin.app_id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}

const lista = document.getElementById("lista");
const pedidosNaTela = new Set();

/* ================= UTIL ================= */
function tempoDecorrido(data){
  const s = Math.floor((Date.now() - new Date(data)) / 1000);
  return Math.floor(s/60) + "m " + (s % 60) + "s";
}

function labelOrigem(p){
  if(p.origem === "garcom") return `Gar√ßom ‚Ä¢ Mesa ${p.mesa_numero || ""}`;
  if(p.origem === "mesa") return `Mesa ${p.mesa_numero || ""}`;
  if(p.origem === "web") return "Pedido Web";
  if(p.origem === "balcao") return "Balc√£o";
  return "Origem n√£o identificada";
}

/* ================= CARREGAR PEDIDOS ================= */
async function carregarPedidos(){

  const { data: pedidos, error } = await sb
    .from("pedidos")
    .select(`
      id,
      created_at,
      mesa_numero,
      cliente_nome,
      cliente_whatsapp,
      origem,
      status,
      atendido
    `)
    .eq("app_id", admin.app_id)
    .eq("status", "aberto")
    .order("created_at", { ascending:true });

  if(error){
    console.error(error);
    return;
  }

  if(pedidos.length === 0){
    lista.innerText = "Nenhum pedido aberto";
    return;
  }

  for(const p of pedidos){

    if(pedidosNaTela.has(p.id)) continue;
    pedidosNaTela.add(p.id);

    const card = document.createElement("div");
    card.className = "pedido novo";

    card.innerHTML = `
      <div class="info">${p.cliente_nome || "Cliente"}</div>
      <div class="origem">${labelOrigem(p)}</div>
      <div class="tempo">Tempo: ${tempoDecorrido(p.created_at)}</div>
    `;

    /* üî• CORRE√á√ÉO PRINCIPAL AQUI üî• */
    const { data: itens, error: erroItens } = await sb
      .from("pedido_itens")
      .select("nome_produto, quantidade, preco")
      .eq("pedido_id", p.id)
      .eq("app_id", admin.app_id)   // ‚úÖ ESSENCIAL
      .order("created_at", { ascending:true });

    if(erroItens){
      console.error(erroItens);
    }

    let total = 0;

    (itens || []).forEach(i=>{
      const qtd = Number(i.quantidade) || 1;
      const preco = Number(i.preco) || 0;
      total += preco * qtd;

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <span>${qtd}x ${i.nome_produto}</span>
        <span>R$ ${(preco * qtd).toFixed(2)}</span>
      `;
      card.appendChild(item);
    });

    const totalDiv = document.createElement("div");
    totalDiv.className = "total";
    totalDiv.innerText = "Total: R$ " + total.toFixed(2);
    card.appendChild(totalDiv);

    const acoes = document.createElement("div");
    acoes.className = "acoes";

    if(!p.atendido){
      const aceitar = document.createElement("button");
      aceitar.className = "btn-aceitar";
      aceitar.innerText = "Aceitar";
      aceitar.onclick = async ()=>{
        await sb.from("pedidos").update({ atendido:true }).eq("id", p.id);
        aceitar.remove();
      };
      acoes.appendChild(aceitar);
    }

    const finalizar = document.createElement("button");
    finalizar.className = "btn-finalizar";
    finalizar.innerText = "Finalizar";
    finalizar.onclick = async ()=>{
      await sb.from("pedidos")
        .update({ status:"finalizado", atendido:true })
        .eq("id", p.id);
      card.remove();
      pedidosNaTela.delete(p.id);
    };
    acoes.appendChild(finalizar);

    card.appendChild(acoes);
    lista.appendChild(card);
    setTimeout(()=>card.classList.remove("novo"),4000);
  }
}

carregarPedidos();
setInterval(carregarPedidos,2000);
</script>

</body>
</html>
