<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gar√ßom - Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npmjs.cloudflare.com/ajax/libs/supabase-js/2.39.3/supabase.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:auto;padding:20px}
.mesa{
  background:#0f172a;
  border-radius:14px;
  padding:16px;
  margin-bottom:14px;
  border-left:6px solid #2563eb;
}
.mesa.atencao{border-left-color:#f59e0b}
.mesa.critico{
  border-left-color:#dc2626;
  box-shadow:0 0 14px rgba(220,38,38,.6);
}
.numero{font-size:22px;font-weight:bold}
.info{margin-top:6px;font-size:14px}
button{
  margin-top:10px;
  padding:10px 14px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
.liberar{background:#dc2626;color:#fff}
</style>
</head>

<body>

<div class="container">
  <h2>üßë‚Äçüç∫ Painel do Gar√ßom</h2>
  <div id="lista">Carregando mesas...</div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const lista = document.getElementById("lista");

/* ===== CARREGAR MESAS (SEM DEPENDER DE app_id) ===== */
async function carregarMesas(){
  const { data: mesas, error } = await sb
    .from("mesas")
    .select("id,numero_mesa,created_at,status")
    .order("numero_mesa");

  if(error){
    lista.innerHTML = "Erro ao carregar mesas";
    console.error(error);
    return;
  }

  lista.innerHTML = "";

  if(!mesas || mesas.length === 0){
    lista.innerHTML = "<p>Nenhuma mesa encontrada</p>";
    return;
  }

  for(const m of mesas){
    await renderMesa(m);
  }
}

/* ===== RENDER ===== */
async function renderMesa(m){
  const { data: pedidos } = await sb
    .from("pedidos")
    .select("id")
    .eq("mesa_id", m.id);

  const minutos =
    (Date.now() - new Date(m.created_at).getTime()) / 60000;

  let classe = "";
  let info = "";

  if(pedidos.length === 0 && minutos >= 6){
    classe = "critico";
    info = "‚ö†Ô∏è Mesa sem pedidos h√° mais de 6 minutos";
  }
  else if(pedidos.length === 0 && minutos >= 4){
    classe = "atencao";
    info = "‚è±Ô∏è Mesa aberta h√° 4 minutos sem pedidos";
  }

  lista.innerHTML += `
    <div class="mesa ${classe}">
      <div class="numero">Mesa ${m.numero_mesa}</div>
      <div class="info">${info}</div>

      ${
        pedidos.length === 0 && minutos >= 6
        ? `<button class="liberar" onclick="liberarMesa('${m.id}')">
             üö® Liberar mesa
           </button>`
        : ``
      }
    </div>
  `;
}

/* ===== LIBERAR ===== */
async function liberarMesa(mesaId){
  const { data: pedidos } = await sb
    .from("pedidos")
    .select("id")
    .eq("mesa_id", mesaId);

  if(pedidos.length > 0){
    alert("Mesa j√° tem pedido");
    return;
  }

  await sb.from("mesas")
    .update({ status:"livre" })
    .eq("id", mesaId);

  carregarMesas();
}

/* START */
carregarMesas();
setInterval(carregarMesas, 30000);
</script>

</body>
</html>
