<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Card√°pio Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#f6f1eb}
.topo{padding:16px;text-align:center;background:#8b5e3c;color:#fff}
.tabs{display:flex;gap:10px;padding:10px}
.tab{flex:1;padding:12px;border-radius:12px;border:none;font-weight:900}
.tab.ativo{background:#8b5e3c;color:#fff}
.container{padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.produto{background:#fff;padding:10px;border-radius:12px}
.produto img{width:100%;height:120px;object-fit:cover;border-radius:10px}
.preco{font-weight:800}
.add{margin-top:6px;width:100%;padding:8px;border:none;border-radius:10px;background:#8b5e3c;color:#fff}
.totalBar{
  position:fixed;bottom:70px;left:0;right:0;
  background:#fff;padding:12px;text-align:center;
  font-weight:900;border-top:1px solid #ddd
}
.carrinhoBtn{
  position:fixed;bottom:15px;left:50%;
  transform:translateX(-50%);
  background:#8b5e3c;color:#fff;
  padding:14px 28px;border-radius:999px;
  font-weight:900
}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.box{
  background:#fff;padding:16px;border-radius:14px;
  width:90%;max-width:400px
}
input,textarea{width:100%;padding:10px;margin-top:6px}
button{cursor:pointer}
</style>
</head>

<body>

<div class="topo">
  <h2 id="nome">Card√°pio Delivery</h2>
</div>

<div class="tabs">
  <button class="tab ativo" id="bar">üç∫ Bar</button>
  <button class="tab" id="cozinha">üçΩÔ∏è Cozinha</button>
</div>

<div class="container" id="lista"></div>

<div class="totalBar">
  Total: R$ <span id="total">0.00</span>
</div>

<div class="carrinhoBtn" onclick="abrirModal()">
  Finalizar pedido
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <h3>Finalizar pedido</h3>
    <input id="nomeCli" placeholder="Seu nome">
    <input id="whatsCli" placeholder="WhatsApp">
    <input id="enderecoCli" placeholder="Endere√ßo">
    <textarea id="refCli" placeholder="Refer√™ncia / observa√ß√£o"></textarea>
    <button onclick="pegarLocal()">üìç Usar localiza√ß√£o</button>
    <button onclick="enviarPedido()" style="margin-top:10px;background:#22c55e;color:#fff;width:100%">Enviar pedido</button>
    <button onclick="fecharModal()" style="margin-top:6px;width:100%">Cancelar</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const params = new URLSearchParams(location.search);
const app_id = params.get("app");
if(!app_id){ alert("App inv√°lido"); }

let produtos=[], carrinho=JSON.parse(localStorage.getItem("carrinho"))||[];
let filtro="BAR";

const lista=document.getElementById("lista");
const totalEl=document.getElementById("total");

function salvarCarrinho(){
  localStorage.setItem("carrinho",JSON.stringify(carrinho));
}

function atualizarTotal(){
  totalEl.innerText = carrinho.reduce((s,i)=>s+i.qtd*i.preco,0).toFixed(2);
  salvarCarrinho();
}

async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("*")
    .eq("app_id",app_id)
    .eq("ativo",true);

  produtos=data||[];
  render();
}

function render(){
  lista.innerHTML="";
  produtos.filter(p=>p.destino===filtro).forEach(p=>{
    lista.innerHTML+=`
      <div class="produto">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b>
        <div class="preco">R$ ${p.preco.toFixed(2)}</div>
        <button class="add" onclick="add('${p.id}')">Adicionar</button>
      </div>
    `;
  });
}

function add(id){
  const p=produtos.find(x=>x.id===id);
  const i=carrinho.find(x=>x.id===id);
  i?i.qtd++:carrinho.push({...p,qtd:1});
  atualizarTotal();
}

function abrirModal(){ document.getElementById("modal").style.display="flex"; }
function fecharModal(){ document.getElementById("modal").style.display="none"; }

function pegarLocal(){
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById("refCli").value =
      `Lat:${pos.coords.latitude}, Lng:${pos.coords.longitude}`;
  });
}

async function enviarPedido(){
  if(!carrinho.length){alert("Carrinho vazio");return;}

  const cliente={
    nome:nomeCli.value,
    whatsapp:whatsCli.value,
    endereco:enderecoCli.value,
    referencia:refCli.value
  };

  // verifica pedido aberto
  const {data:aberto}=await sb.from("pedidos")
    .select("*")
    .eq("app_id",app_id)
    .eq("cliente->>whatsapp",cliente.whatsapp)
    .in("status",["novo","preparo"])
    .maybeSingle();

  if(aberto){
    const novos=[...aberto.itens.produtos,...carrinho.map(i=>({nome:i.nome,qtd:i.qtd,preco:i.preco}))];
    const total=novos.reduce((s,i)=>s+i.qtd*i.preco,0);

    await sb.from("pedidos").update({
      itens:{...aberto.itens,produtos:novos},
      total
    }).eq("id",aberto.id);
  }else{
    await sb.from("pedidos").insert({
      app_id,
      status:"novo",
      cliente,
      itens:{produtos:carrinho},
      total:carrinho.reduce((s,i)=>s+i.qtd*i.preco,0)
    });
  }

  carrinho=[];
  salvarCarrinho();
  atualizarTotal();
  fecharModal();
  alert("Pedido enviado com sucesso üçª");
}

bar.onclick=()=>{filtro="BAR";bar.classList.add("ativo");cozinha.classList.remove("ativo");render();}
cozinha.onclick=()=>{filtro="COZINHA";cozinha.classList.add("ativo");bar.classList.remove("ativo");render();}

atualizarTotal();
carregarProdutos();
</script>

</body>
</html>
