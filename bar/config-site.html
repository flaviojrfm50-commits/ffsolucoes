<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurar Site P√∫blico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --primary:#22c55e;
  --text:#ffffff;
  --muted:#94a3b8;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:'Segoe UI',system-ui,sans-serif;
  background:linear-gradient(135deg,#020617,#020617dd);
  color:var(--text);
  min-height:100vh;
}

.container{
  max-width:420px;
  margin:40px auto;
  padding:28px;
  background:var(--card);
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
  border:1px solid var(--border);
}

h2{
  text-align:center;
  margin-bottom:24px;
}

input, button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
  font-size:0.95rem;
}

input::placeholder{ color:var(--muted); }

button{
  margin-top:20px;
  background:var(--primary);
  color:#022c22;
  font-weight:700;
  border:none;
  cursor:pointer;
}

.preview{
  margin-top:12px;
  max-height:60px;
  max-width:100%;
  object-fit:contain;
  background:#fff;
  padding:6px 10px;
  border-radius:10px;
  display:none;
}

.link{
  margin-top:24px;
  font-size:0.85rem;
  color:var(--muted);
  word-break:break-all;
}
</style>
</head>

<body>

<div class="container">
  <h2>‚öôÔ∏è Configurar Site P√∫blico</h2>

  <input id="nome_site" placeholder="Nome do site (ex: Bar do Z√©)">
  <input id="logo_file" type="file" accept="image/*">
  <img id="logo_preview" class="preview">

  <input id="whatsapp" placeholder="WhatsApp (somente n√∫meros)">
  <small id="wa_preview"></small>

  <button onclick="salvar()">Salvar configura√ß√µes</button>

  <div class="link">
    Link p√∫blico:<br>
    <span id="link"></span>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));

if(!admin || !admin.app_id){
  alert("Admin n√£o autenticado");
  throw new Error("Admin inv√°lido");
}

const app_id = admin.app_id;

/* LINK P√öBLICO ‚Äî PADR√ÉO FINAL */
document.getElementById("link").innerText =
  `https://anajuliafarias659-cloud.github.io/ffsolucoes/bar/public/index.html?app_id=${app_id}`;

const logoInput = document.getElementById("logo_file");
const logoPreview = document.getElementById("logo_preview");
const whatsappInput = document.getElementById("whatsapp");

/* preview local do logo */
logoInput.addEventListener("change", () => {
  const file = logoInput.files[0];
  if(file){
    logoPreview.src = URL.createObjectURL(file);
    logoPreview.style.display = "block";
  }
});

/* preview whatsapp */
whatsappInput.addEventListener("input", e=>{
  const numero = e.target.value.replace(/\D/g,"");
  document.getElementById("wa_preview").innerText =
    numero ? `https://wa.me/55${numero}` : "";
});

/* upload do logo */
async function uploadLogo(file){
  if(!file) return null;

  const ext = file.name.split(".").pop();
  const path = `${app_id}/logo_${Date.now()}.${ext}`;

  const { error } = await sb.storage
    .from("logos")
    .upload(path, file, { upsert:true });

  if(error){
    alert("Erro ao enviar logo");
    return null;
  }

  const { data } = sb.storage
    .from("logos")
    .getPublicUrl(path);

  return data.publicUrl;
}

/* salvar manualmente */
async function salvar(){
  const nome_site = nome_site_input.value?.trim?.() || nome_site.value.trim();
  const whatsapp = whatsappInput.value.trim();
  const fileLogo = logoInput.files[0];

  if(!nome_site){
    alert("Informe o nome do site");
    return;
  }

  let logo_url = null;
  if(fileLogo){
    logo_url = await uploadLogo(fileLogo);
  }

  await sb
    .from("config_site")
    .upsert(
      {
        app_id,
        nome_site,
        whatsapp,
        ...(logo_url && { logo_url })
      },
      { onConflict:"app_id" }
    );

  if(logo_url){
    logoPreview.src = logo_url;
    logoPreview.style.display = "block";
  }

  alert("Configura√ß√µes salvas üî•");
}
</script>

</body>
</html>
