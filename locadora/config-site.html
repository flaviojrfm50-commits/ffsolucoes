<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configura√ß√£o do Site</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:16px 24px;
}
.container{
  max-width:600px;
  margin:30px auto;
  background:#0f172a;
  padding:24px;
  border-radius:16px;
}
label{display:block;margin-top:16px;font-weight:bold}
input,select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:none;
}
button{
  margin-top:20px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.preview{text-align:center;margin-top:16px}
.preview img{max-width:220px;border-radius:12px}
</style>
</head>

<body>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin){
  alert("Acesso negado");
  location.href="../auth/login.html";
}
</script>

<div class="topo">
  <h2>‚öôÔ∏è Configura√ß√£o do Site P√∫blico</h2>
</div>

<div class="container">

  <label>Nome do Site</label>
  <input id="nomeSite">

  <label>WhatsApp</label>
  <input id="whatsapp">

  <label>Cor Prim√°ria</label>
  <input id="corPrimaria" type="color">

  <label>Logo / Banner</label>
  <input type="file" id="logoInput" accept="image/*">

  <label>Tema do Site</label>
  <select id="tema">
    <option value="padrao">Padr√£o</option>
    <option value="automatico">Autom√°tico (datas)</option>
    <option value="ano_novo">üéÜ Ano Novo</option>
    <option value="carnaval">üé≠ Carnaval</option>
    <option value="sao_joao">üî• S√£o Jo√£o</option>
    <option value="natal">üéÑ Natal</option>
  </select>

  <div class="preview">
    <img id="logoPreview" style="display:none">
  </div>

  <button onclick="salvar()">Salvar</button>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const appId = admin.app_id;
let logoFile = null;

logoInput.addEventListener("change", ()=>{
  logoFile = logoInput.files[0];
  const r = new FileReader();
  r.onload = ()=>{ logoPreview.src=r.result; logoPreview.style.display="block"; };
  r.readAsDataURL(logoFile);
});

async function carregar(){
  const { data } = await sb.from("config_site").select("*").eq("app_id",appId).single();
  if(!data) return;

  nomeSite.value = data.nome_site || "";
  whatsapp.value = data.whatsapp || "";
  corPrimaria.value = data.cor_primaria || "#e30613";
  tema.value = data.tema || "padrao";

  if(data.logo_url){
    logoPreview.src = data.logo_url;
    logoPreview.style.display="block";
  }
}

async function uploadLogo(){
  if(!logoFile) return logoPreview.src || null;

  const ext = logoFile.name.split(".").pop();
  const path = `${appId}/logo-${Date.now()}.${ext}`;
  await sb.storage.from("logos").upload(path, logoFile);
  return sb.storage.from("logos").getPublicUrl(path).data.publicUrl;
}

async function salvar(){
  const logoUrl = await uploadLogo();

  await sb.from("config_site").upsert({
    app_id: appId,
    nome_site: nomeSite.value,
    whatsapp: whatsapp.value,
    cor_primaria: corPrimaria.value,
    logo_url: logoUrl,
    tema: tema.value
  },{ onConflict:"app_id" });

  alert("Configura√ß√µes salvas!");
}

carregar();
</script>

</body>
</html>
