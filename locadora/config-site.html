<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configuração do Site</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:16px 24px;
}
.container{
  max-width:600px;
  margin:30px auto;
  background:#0f172a;
  padding:24px;
  border-radius:16px;
}
label{display:block;margin-top:16px;font-weight:bold}
input{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:none;
}
button{
  margin-top:20px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.preview{text-align:center;margin-top:16px}
.preview img{max-width:220px;border-radius:12px;background:#020617}
</style>
</head>

<body>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin){
  alert("Acesso negado");
  location.href="../auth/login.html";
}
</script>

<div class="topo">
  <h2>⚙️ Configuração do Site Público</h2>
</div>

<div class="container">

  <label>Nome do Site</label>
  <input id="nomeSite">

  <label>WhatsApp (somente números)</label>
  <input id="whatsapp">

  <label>Cor Primária</label>
  <input id="corPrimaria" type="color">

  <label>Cor Secundária</label>
  <input id="corSecundaria" type="color">

  <label>Logo / Banner</label>
  <input type="file" id="logoInput" accept="image/*">

  <div class="preview">
    <img id="logoPreview" style="display:none">
  </div>

  <button onclick="salvar()">Salvar</button>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const appId = admin.app_id;
let logoFile = null;

/* PREVIEW */
logoInput.addEventListener("change", ()=>{
  logoFile = logoInput.files[0];
  if(!logoFile) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    logoPreview.src = reader.result;
    logoPreview.style.display = "block";
  };
  reader.readAsDataURL(logoFile);
});

/* CARREGAR CONFIG */
async function carregar(){
  const { data } = await sb
    .from("config_site")
    .select("*")
    .eq("app_id", appId)
    .single();

  if(!data) return;

  nomeSite.value = data.nome_site || "";
  whatsapp.value = data.whatsapp || "";
  corPrimaria.value = data.cor_primaria || "#e30613";
  corSecundaria.value = data.cor_secundaria || "#ffffff";

  if(data.logo_url){
    logoPreview.src = data.logo_url;
    logoPreview.style.display = "block";
  }
}

/* UPLOAD LOGO */
async function uploadLogo(){
  if(!logoFile) return null;

  const ext = logoFile.name.split(".").pop();
  const filePath = `${appId}/logo.${ext}`;

  await sb.storage
    .from("logos")
    .upload(filePath, logoFile, {
      upsert:true,
      contentType:logoFile.type
    });

  const { data } = sb.storage
    .from("logos")
    .getPublicUrl(filePath);

  return data.publicUrl;
}

/* SALVAR */
async function salvar(){
  let logoUrl = logoPreview.src || null;

  if(logoFile){
    logoUrl = await uploadLogo();
  }

  await sb.from("config_site").upsert({
    app_id: appId,
    nome_site: nomeSite.value,
    whatsapp: whatsapp.value,
    cor_primaria: corPrimaria.value,
    cor_secundaria: corSecundaria.value,
    logo_url: logoUrl
  }, { onConflict:"app_id" });

  alert("Configurações salvas com sucesso!");
}

carregar();
</script>

</body>
</html>
